# Story 1.2: Authentication Implementation

## Status
Draft

## Story
**As a** user,
**I want** to log in with credentials to access the system,
**so that** my data is secured and isolated.

## Acceptance Criteria
1. Spring Security configured with JWT-based authentication
2. `/api/auth/login` endpoint accepts username/password and returns JWT token
3. `/api/auth/refresh` endpoint for token refresh functionality
4. Protected endpoints return 401 for unauthorized requests
5. Next.js login page with form validation and error handling
6. Client-side token storage and automatic inclusion in API requests
7. Protected routes redirect to login when unauthenticated
8. Logout functionality clears tokens and redirects to login

## Tasks / Subtasks
- [ ] Create backend authentication module structure (AC: 1, 2, 3, 4)
  - [ ] Create package structure: `com.invoiceme.auth` following VSA patterns
  - [ ] Add Spring Security and JWT dependencies to Maven pom.xml
  - [ ] Create SecurityConfig.java with JWT filter configuration
  - [ ] Create JwtConfig.java for JWT properties

- [ ] Implement JWT token provider and utilities (AC: 1, 2, 3)
  - [ ] Create JwtTokenProvider.java with token generation logic
  - [ ] Implement token validation and extraction methods
  - [ ] Add refresh token generation with longer expiry
  - [ ] Create authentication DTOs (LoginRequest, LoginResponse, RefreshRequest)

- [ ] Build authentication endpoints (AC: 2, 3)
  - [ ] Create AuthController.java with REST endpoints
  - [ ] Implement POST `/api/auth/login` endpoint
  - [ ] Implement POST `/api/auth/refresh` endpoint
  - [ ] Add proper error handling and validation

- [ ] Configure Spring Security (AC: 1, 4)
  - [ ] Create JwtAuthenticationFilter.java for request filtering
  - [ ] Implement UserDetailsServiceImpl.java for user loading
  - [ ] Configure security rules to protect API endpoints
  - [ ] Exclude auth endpoints from authentication requirement

- [ ] Create user entity and repository (AC: 1, 2)
  - [ ] Create User domain entity with id, username, password fields
  - [ ] Create UserRepository interface extending JpaRepository
  - [ ] Add BCrypt password encoding configuration
  - [ ] Create database migration for users table

- [ ] Build frontend authentication service (AC: 5, 6, 7, 8)
  - [ ] Create `lib/api/auth.ts` with login/refresh/logout methods
  - [ ] Implement Axios interceptor for automatic token inclusion
  - [ ] Create Zustand auth store in `lib/stores/auth-store.ts`
  - [ ] Add token refresh interceptor for expired tokens

- [ ] Create login page UI (AC: 5, 7)
  - [ ] Create `app/(auth)/login/page.tsx` with form
  - [ ] Add form validation using react-hook-form and zod
  - [ ] Implement error handling and display
  - [ ] Add loading states during authentication

- [ ] Implement protected route logic (AC: 7, 8)
  - [ ] Create authentication middleware for protected routes
  - [ ] Add layout wrapper for dashboard routes requiring auth
  - [ ] Implement automatic redirect to login when unauthorized
  - [ ] Create logout functionality that clears tokens

- [ ] Write comprehensive tests (AC: 1-8)
  - [ ] Unit tests for JwtTokenProvider
  - [ ] Integration tests for auth endpoints
  - [ ] Frontend component tests for login page
  - [ ] Test protected route behavior

## Dev Notes

### Previous Story Insights
No previous story exists - this is one of the initial stories.

### Data Models
**User Entity** [Source: architecture.md - inferred from auth requirements]:
- id: UUID - Primary key
- username: VARCHAR(100) - Unique, not null
- password: VARCHAR(255) - BCrypt encoded
- createdAt: Timestamp
- updatedAt: Timestamp
No specific user model found in architecture docs, will create minimal implementation for authentication.

### API Specifications
**Authentication Endpoints** [Source: architecture.md#REST API Specification]:
```
POST /auth/login
  Request: { username: string, password: string }
  Response: { token: string, refreshToken: string, expiresIn: integer }

POST /auth/refresh
  Request: { refreshToken: string }
  Response: { token: string, refreshToken: string, expiresIn: integer }
```

**Security Configuration** [Source: architecture.md#Tech Stack]:
- Authentication: Spring Security + JWT
- All endpoints except /auth/* require Bearer token authentication
- JWT expiration: 3600000ms (1 hour) from config

### Component Specifications
**Frontend Auth Service** [Source: architecture.md#Frontend Components]:
- Location: `lib/api/auth.ts`
- Methods: login(credentials), logout(), refreshToken(), getAuthHeader()
- Storage: Zustand store at `lib/stores/auth-store.ts`
- Axios interceptors for automatic token inclusion and refresh

**Backend Auth Module** [Source: architecture.md#Backend Components]:
- JwtTokenProvider - Generate and validate tokens
- AuthenticationController - Login/refresh endpoints
- JwtAuthenticationFilter - Request authentication
- UserDetailsService - Load user for authentication
- Location: `backend/src/main/java/com/invoiceme/auth/`

### File Locations
**Backend** [Source: architecture.md#Source Tree]:
```
backend/src/main/java/com/invoiceme/
  ├── config/
  │   ├── SecurityConfig.java
  │   └── JwtConfig.java
  ├── auth/
  │   ├── AuthController.java
  │   ├── JwtTokenProvider.java
  │   └── UserDetailsServiceImpl.java
```

**Frontend** [Source: architecture.md#Source Tree]:
```
app/(auth)/login/page.tsx
lib/api/auth.ts
lib/stores/auth-store.ts
```

### Testing Requirements
**Testing Strategy** [Source: architecture.md#Tech Stack]:
- Backend: JUnit 5.x + Mockito for unit/integration tests
- Frontend: Jest + React Testing Library for component tests
- Test locations follow Maven standard: `src/test/java` for backend
- Frontend tests colocated with components or in `__tests__` directories

### Technical Constraints
**Dependencies** [Source: architecture.md#Tech Stack]:
- Spring Boot 3.2.x with Spring Security
- Java 17 with modern features
- JJWT library for JWT handling
- BCrypt for password encoding
- Next.js 14.x with TypeScript 5.x
- Zustand 4.x for state management
- Axios for HTTP client

**Configuration** [Source: architecture.md#Configuration]:
- JWT_SECRET environment variable required
- JWT_EXPIRATION: 3600000 (1 hour)
- Database URL for PostgreSQL connection

## Testing
- Unit tests required for all command handlers and domain logic
- Integration tests for REST endpoints verifying auth flows
- Frontend component tests for login form and validation
- Mock external dependencies in tests
- Minimum 80% code coverage for new code
- Tests should follow AAA pattern (Arrange, Act, Assert)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-08 | v1.0 | Initial story creation from PRD | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.1

### Debug Log References
None yet - will be populated during implementation

### Completion Notes List
None yet - will be populated during implementation

### File List
None yet - will be populated during implementation

## QA Results
Not yet reviewed