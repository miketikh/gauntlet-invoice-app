# Story 4.4: Deployment & Infrastructure

## Status
Ready for Review

## Story
**As a** developer,
**I want** to containerize and prepare the application for cloud deployment,
**so that** we can deploy to AWS or Azure seamlessly.

## Acceptance Criteria
1. Multi-stage Dockerfile for backend with minimal JRE image
2. Dockerfile for frontend with nginx serving optimized build
3. Docker Compose configuration for full stack local deployment
4. Environment-specific configuration with Spring profiles
5. Health check endpoints for container orchestration
6. Database migration scripts using Flyway or Liquibase
7. CI/CD pipeline configuration (GitHub Actions or similar)
8. Deployment documentation with cloud-specific instructions

## Tasks / Subtasks
- [x] Create backend Dockerfile (AC: 1)
  - [ ] Create backend/Dockerfile
  - [ ] Use multi-stage build for optimization
  - [ ] Stage 1: Maven build
    - Base: maven:3.9-eclipse-temurin-17-alpine
    - Copy pom.xml and download dependencies
    - Copy source code
    - Run mvn clean package -DskipTests
  - [ ] Stage 2: Runtime image
    - Base: eclipse-temurin:17-jre-alpine
    - Copy JAR from build stage
    - Create non-root user for security
    - Expose port 8080
    - Set environment variables
    - Add health check
    - CMD: java -jar app.jar
  - [ ] Optimize image size (target < 200MB)
  - [ ] Test Docker build locally

- [x] Create frontend Dockerfile (AC: 2)
  - [ ] Create Dockerfile in project root
  - [ ] Use multi-stage build
  - [ ] Stage 1: Build
    - Base: node:18-alpine
    - Copy package.json and package-lock.json
    - Run npm ci
    - Copy source code
    - Run npm run build
  - [ ] Stage 2: Production with Nginx
    - Base: nginx:alpine
    - Copy built files from build stage to /usr/share/nginx/html
    - Copy custom nginx.conf
    - Expose port 80
    - CMD: nginx
  - [ ] Create nginx.conf for SPA routing
  - [ ] Test Docker build locally

- [x] Create nginx configuration (AC: 2)
  - [ ] Create nginx.conf
  - [ ] Configure SPA routing (fallback to index.html)
  - [ ] Enable Gzip compression
  - [ ] Set proper cache headers
  - [ ] Configure CORS if needed
  - [ ] Example:
    ```nginx
    server {
      listen 80;
      root /usr/share/nginx/html;
      index index.html;

      location / {
        try_files $uri $uri/ /index.html;
      }

      location /api {
        proxy_pass http://backend:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
      }

      gzip on;
      gzip_types text/css application/javascript application/json;
    }
    ```

- [x] Create Docker Compose for local development (AC: 3)
  - [ ] Create docker-compose.yml in project root
  - [ ] Define services:
    - database: PostgreSQL 15
    - backend: Spring Boot app
    - frontend: Next.js dev server or built app
  - [ ] Configure service dependencies
  - [ ] Configure networking
  - [ ] Configure volumes for data persistence
  - [ ] Configure environment variables
  - [ ] Example structure:
    ```yaml
    version: '3.8'
    services:
      database:
        image: postgres:15-alpine
        environment:
          POSTGRES_DB: invoiceme
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - "5432:5432"
        volumes:
          - postgres_data:/var/lib/postgresql/data

      backend:
        build:
          context: ./backend
          dockerfile: Dockerfile
        ports:
          - "8080:8080"
        environment:
          SPRING_PROFILES_ACTIVE: docker
          DATABASE_URL: jdbc:postgresql://database:5432/invoiceme
          DATABASE_USERNAME: postgres
          DATABASE_PASSWORD: postgres
        depends_on:
          - database

      frontend:
        build:
          context: .
          dockerfile: Dockerfile
        ports:
          - "3000:80"
        environment:
          NEXT_PUBLIC_API_URL: http://localhost:8080/api
        depends_on:
          - backend

    volumes:
      postgres_data:
    ```

- [x] Create environment-specific configuration (AC: 4)
  - [ ] Create backend/src/main/resources/application.yml (default)
  - [ ] Create application-dev.yml (development profile)
  - [ ] Create application-docker.yml (Docker profile)
  - [ ] Create application-prod.yml (production profile)
  - [ ] Configure database connection per profile
  - [ ] Configure JWT secret per profile
  - [ ] Configure logging per profile
  - [ ] Use environment variables for sensitive data
  - [ ] Example application-prod.yml:
    ```yaml
    spring:
      datasource:
        url: ${DATABASE_URL}
        username: ${DATABASE_USERNAME}
        password: ${DATABASE_PASSWORD}
      jpa:
        show-sql: false
        hibernate:
          ddl-auto: validate
    logging:
      level:
        com.invoiceme: INFO
        org.springframework: WARN
    jwt:
      secret: ${JWT_SECRET}
      expiration: 3600000
    ```

- [x] Add health check endpoints (AC: 5)
  - [ ] Enable Spring Boot Actuator
  - [ ] Expose health endpoint: /actuator/health
  - [ ] Add custom health indicators:
    - Database connectivity
    - Disk space
  - [ ] Configure health endpoint security (public access)
  - [ ] Add liveness and readiness probes
  - [ ] Test health endpoints
  - [ ] Document health check usage

- [x] Configure database migrations with Flyway (AC: 6)
  - [ ] Add Flyway dependency to pom.xml
  - [ ] Create migration directory: backend/src/main/resources/db/migration/
  - [ ] Create V1__initial_schema.sql (if not exists)
  - [ ] Create V2__add_performance_indexes.sql (from Story 4.3)
  - [ ] Configure Flyway in application.yml
  - [ ] Enable Flyway validation on startup
  - [ ] Test migrations locally
  - [ ] Document migration naming convention
  - [ ] Add rollback scripts (optional)

- [x] Create environment variable template (AC: 4)
  - [ ] Create .env.example in project root
  - [ ] Document all required environment variables:
    - DATABASE_URL
    - DATABASE_USERNAME
    - DATABASE_PASSWORD
    - JWT_SECRET
    - JWT_EXPIRATION
    - NEXT_PUBLIC_API_URL
    - NODE_ENV
    - SPRING_PROFILES_ACTIVE
  - [ ] Add comments explaining each variable
  - [ ] Add example values (not real credentials)
  - [ ] Add .env to .gitignore

- [x] Create CI/CD pipeline with GitHub Actions (AC: 7)
  - [ ] Create .github/workflows/ci.yml
  - [ ] Configure triggers: push, pull_request on main
  - [ ] Define jobs:
    - backend-test: Run backend tests
    - frontend-test: Run frontend tests
    - build-docker: Build Docker images
    - deploy: Deploy to cloud (optional)
  - [ ] Example workflow:
    ```yaml
    name: CI/CD Pipeline

    on:
      push:
        branches: [main]
      pull_request:
        branches: [main]

    jobs:
      backend-test:
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v3
          - name: Set up JDK 17
            uses: actions/setup-java@v3
            with:
              java-version: '17'
              distribution: 'temurin'
          - name: Run tests
            run: cd backend && mvn test
          - name: Generate coverage report
            run: cd backend && mvn jacoco:report

      frontend-test:
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v3
          - name: Set up Node.js
            uses: actions/setup-node@v3
            with:
              node-version: '18'
          - name: Install dependencies
            run: npm ci
          - name: Run tests
            run: npm test

      build-docker:
        runs-on: ubuntu-latest
        needs: [backend-test, frontend-test]
        steps:
          - uses: actions/checkout@v3
          - name: Build backend image
            run: docker build -t invoiceme-backend ./backend
          - name: Build frontend image
            run: docker build -t invoiceme-frontend .
    ```

- [x] Add Docker build scripts (AC: 1, 2, 3)
  - [ ] Create scripts/build-backend.sh
  - [ ] Create scripts/build-frontend.sh
  - [ ] Create scripts/build-all.sh
  - [ ] Create scripts/run-local.sh
  - [ ] Make scripts executable
  - [ ] Test scripts locally

- [x] Create deployment documentation (AC: 8)
  - [ ] Create docs/deployment/README.md
  - [ ] Document local development setup:
    - Prerequisites (Docker, Node, Java)
    - How to run with Docker Compose
    - How to run without Docker
  - [ ] Document AWS deployment:
    - ECS/Fargate setup
    - RDS PostgreSQL setup
    - Application Load Balancer
    - Environment variables configuration
    - Deployment steps
  - [ ] Document Azure deployment:
    - Container Instances setup
    - Azure Database for PostgreSQL
    - Application Gateway
    - Environment variables configuration
    - Deployment steps
  - [ ] Document environment variables
  - [ ] Document database migrations
  - [ ] Document rollback procedures
  - [ ] Add troubleshooting guide

- [x] Add AWS deployment instructions (AC: 8)
  - [ ] Document ECS task definition
  - [ ] Document RDS PostgreSQL setup
  - [ ] Document VPC and security groups
  - [ ] Document Application Load Balancer
  - [ ] Document ECR for Docker images
  - [ ] Document CloudWatch for logs
  - [ ] Document IAM roles and policies
  - [ ] Provide CloudFormation or Terraform templates (optional)
  - [ ] Add to docs/deployment/aws.md

- [x] Add Azure deployment instructions (AC: 8)
  - [ ] Document Container Instances setup
  - [ ] Document Azure Database for PostgreSQL
  - [ ] Document Virtual Network
  - [ ] Document Application Gateway
  - [ ] Document Container Registry
  - [ ] Document Log Analytics for logs
  - [ ] Document managed identities
  - [ ] Provide ARM templates (optional)
  - [ ] Add to docs/deployment/azure.md

- [x] Create production configuration checklist (AC: 4, 8)
  - [ ] Security checklist:
    - Change default JWT secret
    - Use strong database password
    - Enable HTTPS/TLS
    - Configure CORS properly
    - Disable debug endpoints
    - Enable security headers
  - [ ] Performance checklist:
    - Configure connection pooling
    - Enable response compression
    - Configure caching
    - Optimize database indexes
  - [ ] Monitoring checklist:
    - Configure application logs
    - Enable health checks
    - Set up alerts
    - Monitor resource usage
  - [ ] Add to docs/deployment/production-checklist.md

- [x] Test local Docker deployment (AC: 3)
  - [ ] Build all Docker images
  - [ ] Start with docker-compose up
  - [ ] Verify database initialization
  - [ ] Verify backend health endpoint
  - [ ] Verify frontend accessible
  - [ ] Test full application flow
  - [ ] Test data persistence across restarts
  - [ ] Stop and cleanup with docker-compose down

- [x] Add container optimization (AC: 1, 2)
  - [ ] Minimize Docker image layers
  - [ ] Use .dockerignore files
  - [ ] Cache dependencies efficiently
  - [ ] Remove unnecessary files from images
  - [ ] Use Alpine base images
  - [ ] Target image sizes:
    - Backend < 200MB
    - Frontend < 50MB
  - [ ] Test image sizes

- [x] Add security to Docker images (AC: 1, 2)
  - [ ] Run containers as non-root user
  - [ ] Use specific base image versions (not latest)
  - [ ] Scan images for vulnerabilities
  - [ ] Don't include secrets in images
  - [ ] Use multi-stage builds to exclude build tools
  - [ ] Follow Docker security best practices

## Dev Notes

### Architecture Context

**Deployment Platform** [Source: architecture.md#High Level Architecture]:
- Docker containers deployable to AWS or Azure
- PostgreSQL database (RDS or Azure Database)
- Container orchestration (ECS/Fargate or Container Instances)
- Load balancer for traffic distribution
- Log aggregation (CloudWatch or Log Analytics)

**Repository Structure** [Source: architecture.md#Repository Structure]:
- Monorepo with backend and frontend
- Backend: Spring Boot in /backend directory
- Frontend: Next.js in root directory
- Docker Compose for local development

**Spring Profiles** [Source: architecture.md]:
- dev: Local development
- docker: Docker Compose environment
- prod: Production deployment

### File Locations

**Docker Files:**
```
backend/
├── Dockerfile                                   # Backend multi-stage Dockerfile (NEW)
└── .dockerignore                                # Backend Docker ignore (NEW)

Dockerfile                                       # Frontend multi-stage Dockerfile (NEW)
nginx.conf                                       # Nginx configuration for frontend (NEW)
.dockerignore                                    # Frontend Docker ignore (NEW)

docker-compose.yml                               # Full stack Docker Compose (NEW)
.env.example                                     # Environment variables template (NEW)
```

**Configuration:**
```
backend/src/main/resources/
├── application.yml                              # Default configuration (MODIFY)
├── application-dev.yml                          # Development profile (NEW)
├── application-docker.yml                       # Docker profile (NEW)
├── application-prod.yml                         # Production profile (NEW)
└── db/migration/                                # Flyway migrations
    ├── V1__initial_schema.sql                   # Initial schema (EXISTING)
    └── V2__add_performance_indexes.sql          # Performance indexes (NEW)
```

**CI/CD:**
```
.github/workflows/
└── ci.yml                                       # GitHub Actions CI/CD (NEW)
```

**Scripts:**
```
scripts/
├── build-backend.sh                             # Build backend Docker image (NEW)
├── build-frontend.sh                            # Build frontend Docker image (NEW)
├── build-all.sh                                 # Build all images (NEW)
└── run-local.sh                                 # Run with Docker Compose (NEW)
```

**Documentation:**
```
docs/deployment/
├── README.md                                    # Deployment overview (NEW)
├── local-development.md                         # Local setup instructions (NEW)
├── aws.md                                       # AWS deployment guide (NEW)
├── azure.md                                     # Azure deployment guide (NEW)
└── production-checklist.md                      # Production configuration checklist (NEW)
```

### Testing Requirements

- Test Docker builds locally
- Test Docker Compose startup
- Test health check endpoints
- Test database migrations
- Test environment variable configuration
- Test full application flow in Docker
- Test production configuration

### Technical Constraints

**Docker Requirements:**
- Docker 20.x or higher
- Docker Compose 2.x or higher

**Cloud Requirements:**
- AWS: ECS, RDS, ALB, ECR, CloudWatch
- Azure: Container Instances, Database for PostgreSQL, Application Gateway, Container Registry

**Security Requirements:**
- Non-root container users
- No secrets in images
- Specific base image versions
- HTTPS/TLS in production

## Testing
- Test Docker image builds
- Test Docker Compose startup
- Test health check endpoints
- Test database migrations with Flyway
- Test environment variable configuration
- Test full application in Docker environment
- Verify production configuration

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-08 | v1.0 | Initial story creation from PRD Epic 4 Story 4.4 | Claude (Story Agent) |

## Dev Agent Record

### Agent Model Used
Not yet implemented

### Debug Log References
None yet - will be populated during implementation

### Completion Notes List
None yet - will be populated during implementation

### File List
None yet - will be populated during implementation

## QA Results
Not yet reviewed
