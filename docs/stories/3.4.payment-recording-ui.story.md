# Story 3.4: Payment Recording UI

## Status
Draft

## Story
**As a** user,
**I want** to record payments against sent invoices,
**so that** I can track payment collection and update invoice status.

## Acceptance Criteria
1. Payment recording modal/form accessible from invoice detail view
2. Form shows invoice details: number, customer, total, balance due
3. Payment amount field with validation (cannot exceed balance)
4. Payment method dropdown and reference number field
5. Optional notes field for payment details
6. Real-time balance calculation showing remaining after payment
7. Success notification and invoice status update after recording
8. Payment button disabled for Draft or fully Paid invoices

## Tasks / Subtasks
- [ ] Create PaymentForm component (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Create PaymentForm.tsx in components/payments/
  - [ ] Import necessary Shadcn/ui components: Dialog, Form, Input, Select, Button, Label
  - [ ] Define component props interface:
    - invoice: InvoiceResponseDTO (containing invoice details)
    - open: boolean (dialog visibility state)
    - onOpenChange: (open: boolean) => void
    - onSuccess: () => void (callback after successful payment)
  - [ ] Use React Hook Form with zod validation:
    - paymentDate: date (required, default to today)
    - amount: number (required, min: 0.01, max: invoice.balance)
    - paymentMethod: PaymentMethod (required)
    - reference: string (required, min 1 char)
    - notes: string (optional)
  - [ ] Create Zod schema for payment validation:
    - amount cannot exceed invoice balance
    - amount must be positive
    - paymentDate cannot be in future
  - [ ] Display invoice context at top of form (read-only):
    - Invoice Number: {invoice.invoiceNumber}
    - Customer: {invoice.customerName}
    - Invoice Total: ${invoice.totalAmount}
    - Current Balance: ${invoice.balance}
  - [ ] Create form fields:
    - Payment Date picker (default to today)
    - Amount input with currency formatting ($)
    - Payment Method dropdown (CreditCard, BankTransfer, Check, Cash)
    - Reference number text input
    - Notes textarea (optional)
  - [ ] Implement real-time balance calculation:
    - Calculate: remainingBalance = invoice.balance - amount
    - Display below amount field: "Remaining Balance: ${remainingBalance}"
    - Update on amount change
    - Show warning if remainingBalance < 0
  - [ ] Add form submission handler:
    - Call API: POST /api/invoices/{id}/payments
    - Pass RecordPaymentDTO to backend
    - Show loading state during submission
    - Handle errors with toast notifications
    - On success: call onSuccess callback, show success toast, close dialog
  - [ ] Style with Tailwind CSS following Shadcn/ui patterns
  - [ ] Ensure responsive design (works on desktop and tablet)

- [ ] Add payment recording to InvoiceDetail page (AC: 1, 7, 8)
  - [ ] Modify InvoiceDetail.tsx in app/(dashboard)/invoices/[id]/page.tsx
  - [ ] Import PaymentForm component
  - [ ] Add state for dialog visibility: const [paymentDialogOpen, setPaymentDialogOpen] = useState(false)
  - [ ] Add "Record Payment" button:
    - Position in invoice detail header or actions section
    - Only visible when invoice status is 'Sent'
    - Disabled when status is 'Draft' or 'Paid'
    - onClick: setPaymentDialogOpen(true)
  - [ ] Render PaymentForm component:
    - Pass invoice data from current invoice
    - Pass open state and onOpenChange handler
    - Pass onSuccess callback to refresh invoice data
  - [ ] Implement onSuccess callback:
    - Refetch invoice data to update status and balance
    - Show success toast: "Payment of ${amount} recorded successfully"
    - If invoice now fully paid, show: "Invoice marked as Paid"
    - Close payment dialog
  - [ ] Add conditional rendering for button:
    - if (invoice.status === 'Draft') button disabled with tooltip "Cannot record payment for draft invoice"
    - if (invoice.status === 'Paid') button disabled with tooltip "Invoice is fully paid"
    - if (invoice.status === 'Sent') button enabled
  - [ ] Update invoice display after payment:
    - Refetch invoice to show updated balance
    - Update status badge if changed to Paid
    - Ensure payment appears in payment history (if visible)

- [ ] Create payment API service methods (AC: 3, 4, 6, 7)
  - [ ] Update lib/api/payments.ts
  - [ ] Create recordPayment function:
    - Type signature: recordPayment(invoiceId: string, dto: RecordPaymentDTO): Promise<PaymentResponseDTO>
    - API call: POST /api/invoices/{invoiceId}/payments
    - Include JWT token in Authorization header
    - Request body: JSON serialization of RecordPaymentDTO
    - Response: PaymentResponseDTO
    - Error handling: catch and rethrow with meaningful messages
  - [ ] Add TypeScript types if not already defined:
    - RecordPaymentDTO interface
    - PaymentResponseDTO interface
  - [ ] Add request/response interceptors for error handling:
    - 400 Bad Request: validation errors (amount exceeds balance)
    - 404 Not Found: invoice not found
    - 403 Forbidden: cannot record payment on Draft invoice
    - 500 Server Error: generic error handling
  - [ ] Return parsed response with correct typing

- [ ] Implement payment method dropdown (AC: 4)
  - [ ] Create PaymentMethodSelect component (or inline in PaymentForm)
  - [ ] Use Shadcn/ui Select component
  - [ ] Define payment method options:
    - CreditCard: "Credit Card"
    - BankTransfer: "Bank Transfer"
    - Check: "Check"
    - Cash: "Cash"
  - [ ] Map PaymentMethod enum to display labels
  - [ ] Set default value to most common method (e.g., CreditCard)
  - [ ] Bind to React Hook Form controller
  - [ ] Style consistently with other form fields

- [ ] Add client-side validation (AC: 3, 6)
  - [ ] Amount validation:
    - Required field
    - Must be positive number (> 0)
    - Cannot exceed invoice.balance
    - Show error: "Amount cannot exceed balance due (${invoice.balance})"
  - [ ] Payment date validation:
    - Required field
    - Cannot be in future
    - Show error: "Payment date cannot be in the future"
  - [ ] Reference validation:
    - Required field
    - Minimum 1 character
    - Show error: "Reference number is required"
  - [ ] Payment method validation:
    - Required field
    - Must be valid enum value
  - [ ] Real-time validation feedback:
    - Show errors below fields
    - Disable submit button if form invalid
    - Red border on invalid fields
  - [ ] Calculate and display remaining balance:
    - const remaining = invoice.balance - amount
    - if (remaining >= 0) show green: "Remaining: ${remaining}"
    - if (remaining < 0) show red: "Amount exceeds balance!"

- [ ] Implement success notification (AC: 7)
  - [ ] Use Shadcn/ui Toast component
  - [ ] On successful payment recording:
    - Show toast: "Payment of ${amount} recorded successfully"
    - Duration: 3000ms
    - Type: success (green)
  - [ ] If invoice status changed to Paid:
    - Show additional toast: "Invoice #{invoiceNumber} is now fully paid"
    - Duration: 4000ms
    - Type: success
  - [ ] On error:
    - Show error toast with backend error message
    - Duration: 5000ms
    - Type: error (red)
  - [ ] Ensure toasts are accessible (WCAG AA)

- [ ] Add button state management (AC: 8)
  - [ ] Create helper function to determine button state:
    - isPaymentButtonDisabled(invoice: InvoiceResponseDTO): boolean
    - Return true if invoice.status === 'Draft'
    - Return true if invoice.status === 'Paid'
    - Return true if invoice.balance <= 0
    - Return false if invoice.status === 'Sent' && balance > 0
  - [ ] Apply disabled state to "Record Payment" button
  - [ ] Add Shadcn/ui Tooltip for disabled states:
    - Draft: "Cannot record payment for draft invoices. Send invoice first."
    - Paid: "This invoice is fully paid."
    - Balance 0: "No balance remaining."
  - [ ] Change button styling when disabled (grayed out)
  - [ ] Ensure keyboard accessibility (tab navigation, tooltips)

- [ ] Integrate with invoice store (AC: 7)
  - [ ] Update lib/stores/invoice-store.ts (if using Zustand)
  - [ ] Add recordPayment action:
    - Takes invoiceId and RecordPaymentDTO
    - Calls payments API service
    - Updates invoice in store on success
    - Handles errors and updates error state
  - [ ] Add refreshInvoice action:
    - Refetches single invoice by ID
    - Updates store with latest data (including updated balance and status)
  - [ ] Call refreshInvoice in PaymentForm onSuccess:
    - Ensures invoice detail view reflects new balance
    - Ensures status badge updates if invoice now Paid
  - [ ] Alternatively, refetch invoice data directly in InvoiceDetail component

- [ ] Add loading states and error handling (AC: 3, 7)
  - [ ] Show loading spinner during payment submission:
    - Disable form fields while submitting
    - Show spinner on submit button: "Recording..."
    - Prevent duplicate submissions
  - [ ] Handle API errors gracefully:
    - 400 validation error: show field-specific errors
    - 404 invoice not found: show error toast
    - 403 forbidden (draft invoice): show error toast
    - Network errors: show retry option
  - [ ] Show loading state on "Record Payment" button if needed
  - [ ] Handle edge case: invoice deleted or changed while dialog open

- [ ] Create TypeScript types for payment (AC: 1-8)
  - [ ] Update types/payment.ts
  - [ ] Ensure RecordPaymentDTO matches backend:
    ```typescript
    interface RecordPaymentDTO {
      paymentDate: Date;
      amount: number;
      paymentMethod: PaymentMethod;
      reference: string;
      notes?: string;
    }
    ```
  - [ ] Ensure PaymentResponseDTO includes all fields from backend
  - [ ] Export PaymentMethod enum:
    ```typescript
    type PaymentMethod = 'CreditCard' | 'BankTransfer' | 'Check' | 'Cash';
    ```
  - [ ] Align with backend Java types exactly

- [ ] Style payment form with Shadcn/ui (AC: 1, 2)
  - [ ] Use Dialog component for modal:
    - DialogTrigger on "Record Payment" button
    - DialogContent for form
    - DialogHeader with title "Record Payment"
    - DialogFooter with Cancel and Submit buttons
  - [ ] Apply Tailwind CSS classes:
    - Form fields: consistent spacing, labels, error states
    - Invoice details section: bg-gray-50, p-4, rounded, mb-4
    - Amount field: text-xl font-semibold for emphasis
    - Remaining balance: color-coded (green if positive, red if negative)
  - [ ] Ensure consistent styling with rest of application
  - [ ] Follow Shadcn/ui design system patterns
  - [ ] Responsive design: stack fields on mobile, two-column on desktop

- [ ] Add payment form accessibility (AC: 1-8)
  - [ ] All form fields have associated labels
  - [ ] Use ARIA attributes:
    - aria-label for icons
    - aria-describedby for error messages
    - aria-invalid for fields with errors
  - [ ] Keyboard navigation:
    - Tab through all fields
    - Enter to submit form
    - Escape to close dialog
  - [ ] Focus management:
    - Focus amount field on dialog open
    - Return focus to trigger button on close
  - [ ] Screen reader support:
    - Announce errors to screen readers
    - Announce success/error toasts
  - [ ] Color contrast: ensure WCAG AA compliance
  - [ ] Test with keyboard-only navigation

- [ ] Create comprehensive UI tests (AC: 1-8)
  - [ ] Create PaymentForm.test.tsx
  - [ ] Test component renders with invoice data
  - [ ] Test form validation:
    - Amount required
    - Amount cannot exceed balance
    - Amount must be positive
    - Payment date required
    - Reference required
  - [ ] Test real-time balance calculation:
    - Enter amount, verify remaining balance updates
    - Enter amount > balance, verify error shown
  - [ ] Test form submission:
    - Mock API call
    - Verify correct DTO sent to API
    - Verify onSuccess callback called
    - Verify dialog closes on success
  - [ ] Test error handling:
    - Mock API error
    - Verify error toast shown
    - Verify form stays open on error
  - [ ] Test payment method dropdown renders all options
  - [ ] Test disabled state for Draft/Paid invoices
  - [ ] Test tooltip shows correct message for disabled states
  - [ ] Use React Testing Library
  - [ ] Mock invoice data with InvoiceTestBuilder pattern

- [ ] Add E2E test for payment recording (AC: 1-8)
  - [ ] Create payment-recording.spec.ts (Playwright)
  - [ ] Test complete payment flow:
    - Navigate to invoice detail page
    - Click "Record Payment" button
    - Fill in payment form with valid data
    - Submit form
    - Verify success toast appears
    - Verify invoice balance updated
    - Verify invoice status updated if fully paid
  - [ ] Test validation errors:
    - Try to submit with amount > balance
    - Verify error shown
    - Correct amount and submit successfully
  - [ ] Test disabled states:
    - Navigate to Draft invoice, verify button disabled
    - Navigate to Paid invoice, verify button disabled
  - [ ] Test keyboard navigation:
    - Open form with Enter key
    - Tab through fields
    - Submit with Enter
    - Close with Escape
  - [ ] Run E2E test in CI pipeline

- [ ] Update invoice detail view to show payment button (AC: 1, 8)
  - [ ] Ensure InvoiceDetail page has clear actions section
  - [ ] Position "Record Payment" button prominently:
    - In header actions area, or
    - Below invoice details, above line items, or
    - As floating action button (mobile)
  - [ ] Add icon to button (e.g., dollar sign or payment icon)
  - [ ] Ensure button visibility on all screen sizes
  - [ ] Add clear visual hierarchy:
    - Primary button style for enabled state
    - Muted/disabled style for disabled state
  - [ ] Consider adding "Send Invoice" button nearby if status is Draft

- [ ] Implement form reset on dialog close (AC: 1)
  - [ ] Reset form fields when dialog closes:
    - Clear all field values
    - Clear validation errors
    - Reset to default values (paymentDate = today)
  - [ ] Use React Hook Form reset() method
  - [ ] Reset on:
    - Dialog close (X button or outside click)
    - Successful submission
    - Cancel button click
  - [ ] Prevent form state from persisting across dialog opens

- [ ] Add currency formatting helpers (AC: 2, 6)
  - [ ] Create formatCurrency utility in lib/utils.ts:
    ```typescript
    export function formatCurrency(amount: number): string {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
      }).format(amount);
    }
    ```
  - [ ] Use formatCurrency for:
    - Invoice total display
    - Current balance display
    - Amount input (format on blur)
    - Remaining balance display
  - [ ] Ensure consistent currency formatting across app
  - [ ] Handle edge cases: null, undefined, negative values

- [ ] Document payment recording flow (AC: 1-8)
  - [ ] Add JSDoc comments to PaymentForm component
  - [ ] Document props and their purposes
  - [ ] Document validation rules
  - [ ] Document API integration
  - [ ] Add usage example in component documentation
  - [ ] Update any relevant technical docs with payment flow

## Dev Notes

### Previous Story Insights

**Story 3.3 Completion:**
Story 3.3 implemented payment queries and history:
- GetPaymentByIdQuery, ListPaymentsByInvoiceQuery, PaymentHistoryQuery
- GET /api/payments/{id}, GET /api/invoices/{id}/payments endpoints
- PaymentResponseDTO with invoice and customer context
- Running balance calculation for payment history
- Payment statistics for dashboard
- Comprehensive query tests

**Story 3.2 Completion:**
Story 3.2 implemented payment recording commands:
- RecordPaymentCommand and RecordPaymentCommandHandler
- POST /api/invoices/{id}/payments endpoint
- Transactional payment recording with invoice balance update
- Invoice status transition to Paid when balance reaches zero
- PaymentRecorded domain event
- Idempotency handling
- Integration and API tests

**Story 3.1 Completion:**
Story 3.1 implemented the Payment domain model:
- Payment entity with validation logic
- PaymentMethod enum
- PaymentRepository interface
- PaymentService for reconciliation logic
- Database schema for payments table
- Unit tests for domain logic

**Epic 2 UI Patterns:**
Stories 2.4 and 2.5 established UI patterns for invoice management:
- Modal/dialog patterns for complex forms
- Real-time calculation and validation
- Shadcn/ui Dialog, Form, Input, Select components
- React Hook Form with Zod validation
- Success/error toast notifications
- Disabled states with tooltips
- Loading states during API calls
- Responsive design patterns

**Epic 1 UI Patterns:**
Story 1.5 implemented Customer UI:
- CRUD operations with forms and dialogs
- Client-side validation matching backend rules
- Shadcn/ui component library usage
- Zustand state management
- API service integration
- Loading states and error handling
- Responsive design

### Data Models

**RecordPaymentDTO** [Source: architecture.md#Data Models]:
```typescript
interface RecordPaymentDTO {
  paymentDate: Date;        // Date payment was made
  amount: number;           // Payment amount (positive, <= invoice.balance)
  paymentMethod: PaymentMethod;  // Payment method enum
  reference: string;        // Transaction reference or check number
  notes?: string;           // Optional payment notes
}
```

**PaymentMethod Enum** [Source: architecture.md#Data Models]:
```typescript
type PaymentMethod = 'CreditCard' | 'BankTransfer' | 'Check' | 'Cash';
```

**PaymentResponseDTO** [Source: Story 3.3]:
```typescript
interface PaymentResponseDTO {
  id: string;
  invoiceId: string;
  invoiceNumber: string;
  customerName: string;
  customerEmail: string;
  paymentDate: Date;
  amount: number;
  paymentMethod: PaymentMethod;
  reference: string;
  notes?: string;
  invoiceTotal: number;
  remainingBalance: number;    // Invoice balance after this payment
  runningBalance?: number;     // Only in payment history queries
  invoiceStatus: InvoiceStatus;
  createdAt: Date;
  createdBy: string;
}
```

**InvoiceResponseDTO** [Source: architecture.md#Data Models]:
```typescript
interface InvoiceResponseDTO extends Invoice {
  customerName?: string;
  customerEmail?: string;
  paymentHistory?: Payment[];
  daysOverdue?: number;
}
```

### API Specifications

**POST /api/invoices/{id}/payments** [Source: Story 3.2, architecture.md#API Specification]:

**Request:**
```
POST /api/invoices/{invoiceId}/payments
Authorization: Bearer {jwt_token}
Content-Type: application/json

{
  "paymentDate": "2024-11-08",
  "amount": 250.00,
  "paymentMethod": "CreditCard",
  "reference": "VISA-****-1234",
  "notes": "Partial payment received"
}
```

**Response (201 Created):**
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "invoiceId": "660e8400-e29b-41d4-a716-446655440000",
  "invoiceNumber": "INV-2024-0123",
  "customerName": "Acme Corporation",
  "customerEmail": "billing@acme.com",
  "paymentDate": "2024-11-08",
  "amount": 250.00,
  "paymentMethod": "CreditCard",
  "reference": "VISA-****-1234",
  "notes": "Partial payment received",
  "invoiceTotal": 500.00,
  "remainingBalance": 250.00,
  "invoiceStatus": "Sent",
  "createdAt": "2024-11-08T14:30:00Z",
  "createdBy": "user@example.com"
}
```

**Error Responses:**
- **400 Bad Request**: Validation error (amount exceeds balance, payment on draft invoice)
- **404 Not Found**: Invoice not found
- **403 Forbidden**: Cannot record payment on Draft invoice
- **401 Unauthorized**: Missing or invalid JWT token

### Component Specifications

**PaymentForm Component** [Derived from PRD Epic 3 Story 3.4 AC 1-6]:
- Location: components/payments/PaymentForm.tsx
- Purpose: Modal dialog form for recording payments against invoices
- Props:
  - invoice: InvoiceResponseDTO (invoice to apply payment to)
  - open: boolean (dialog visibility state)
  - onOpenChange: (open: boolean) => void (dialog state handler)
  - onSuccess: () => void (callback after successful payment)
- Features:
  - Displays invoice context (number, customer, total, balance)
  - Form fields: payment date, amount, method, reference, notes
  - Real-time balance calculation: remainingBalance = invoice.balance - amount
  - Client-side validation: amount > 0, amount <= balance, date not future
  - Submits to POST /api/invoices/{id}/payments
  - Shows success toast on completion
  - Closes dialog and refreshes invoice on success
- Validation:
  - Amount: required, positive, <= invoice.balance
  - Payment date: required, not in future
  - Payment method: required, valid enum value
  - Reference: required, min 1 character
- Dependencies: Shadcn/ui Dialog, Form, Input, Select, React Hook Form, Zod

**InvoiceDetail Updates** [Derived from PRD Epic 3 Story 3.4 AC 1, 7, 8]:
- Location: app/(dashboard)/invoices/[id]/page.tsx
- Add "Record Payment" button:
  - Visible only when invoice.status === 'Sent'
  - Disabled when invoice.status === 'Draft' or 'Paid'
  - Opens PaymentForm dialog
  - Shows tooltip on disabled state explaining why
- Integrate PaymentForm component:
  - Pass current invoice data
  - Handle onSuccess to refetch invoice
  - Update UI to show new balance and status
- Show success notification after payment recorded
- Update invoice status badge if changed to Paid

### File Locations

**Frontend Files** [Source: architecture.md#Unified Project Structure]:
```
components/payments/
├── payment-form.tsx                  # Main payment recording form (NEW)
└── payment-history.tsx               # Payment history component (Story 3.5)

app/(dashboard)/invoices/[id]/
└── page.tsx                          # Invoice detail page (MODIFY to add payment button)

lib/api/
└── payments.ts                       # Payment API service (ADD recordPayment function)

types/
└── payment.ts                        # Payment TypeScript types (VERIFY RecordPaymentDTO)

lib/stores/
└── invoice-store.ts                  # Invoice store (OPTIONAL: add recordPayment action)

lib/
└── utils.ts                          # Utilities (ADD formatCurrency helper)

__tests__/components/payments/
└── payment-form.test.tsx             # PaymentForm component tests (NEW)

e2e/
└── payment-recording.spec.ts         # E2E test for payment flow (NEW)
```

### Testing Requirements

**Testing Strategy** [Source: architecture.md#Tech Stack, PRD Technical Assumptions]:
- Component tests with React Testing Library
- Test PaymentForm rendering with invoice data
- Test form validation (amount, date, reference)
- Test real-time balance calculation
- Test form submission and API integration
- Test error handling and toast notifications
- Test disabled states (Draft, Paid invoices)
- Test keyboard navigation and accessibility
- E2E test for complete payment recording flow
- Minimum 85% code coverage on UI components

**Component Test Structure**:
```typescript
describe('PaymentForm', () => {
  const mockInvoice: InvoiceResponseDTO = {
    id: '123',
    invoiceNumber: 'INV-2024-0001',
    customerName: 'Acme Corp',
    totalAmount: 500.00,
    balance: 250.00,
    status: 'Sent',
    // ... other fields
  };

  it('should render invoice details', () => {
    render(
      <PaymentForm
        invoice={mockInvoice}
        open={true}
        onOpenChange={jest.fn()}
        onSuccess={jest.fn()}
      />
    );

    expect(screen.getByText('INV-2024-0001')).toBeInTheDocument();
    expect(screen.getByText('Acme Corp')).toBeInTheDocument();
    expect(screen.getByText('$500.00')).toBeInTheDocument();
    expect(screen.getByText('$250.00')).toBeInTheDocument();
  });

  it('should validate amount does not exceed balance', async () => {
    render(<PaymentForm invoice={mockInvoice} open={true} onOpenChange={jest.fn()} onSuccess={jest.fn()} />);

    const amountInput = screen.getByLabelText(/amount/i);
    await userEvent.type(amountInput, '300.00');

    await waitFor(() => {
      expect(screen.getByText(/cannot exceed balance/i)).toBeInTheDocument();
    });
  });

  it('should calculate remaining balance in real-time', async () => {
    render(<PaymentForm invoice={mockInvoice} open={true} onOpenChange={jest.fn()} onSuccess={jest.fn()} />);

    const amountInput = screen.getByLabelText(/amount/i);
    await userEvent.type(amountInput, '100.00');

    await waitFor(() => {
      expect(screen.getByText(/Remaining.*150\.00/i)).toBeInTheDocument();
    });
  });

  it('should call API and show success on submit', async () => {
    const mockRecordPayment = jest.fn().mockResolvedValue({
      id: 'payment-123',
      amount: 100.00,
      // ... response
    });
    (paymentsApi.recordPayment as jest.Mock) = mockRecordPayment;

    const onSuccess = jest.fn();
    render(<PaymentForm invoice={mockInvoice} open={true} onOpenChange={jest.fn()} onSuccess={onSuccess} />);

    // Fill form and submit
    await userEvent.type(screen.getByLabelText(/amount/i), '100.00');
    await userEvent.selectOptions(screen.getByLabelText(/payment method/i), 'CreditCard');
    await userEvent.type(screen.getByLabelText(/reference/i), 'VISA-1234');
    await userEvent.click(screen.getByRole('button', { name: /submit|record/i }));

    await waitFor(() => {
      expect(mockRecordPayment).toHaveBeenCalledWith('123', {
        paymentDate: expect.any(Date),
        amount: 100.00,
        paymentMethod: 'CreditCard',
        reference: 'VISA-1234',
        notes: ''
      });
      expect(onSuccess).toHaveBeenCalled();
    });
  });
});
```

### Technical Constraints

**Dependencies** [Source: architecture.md#Tech Stack]:
- Next.js 14.x
- TypeScript 5.x
- Shadcn/ui component library
- Tailwind CSS 3.x
- React Hook Form for form management
- Zod for validation schemas
- Zustand 4.x for state management
- Axios for API calls
- date-fns for date handling
- React Testing Library for component tests
- Playwright for E2E tests

**UI/UX Requirements** [Source: PRD User Interface Design Goals]:
- Modern, clean ERP interface
- Consistent styling with Shadcn/ui design system
- Responsive design (desktop and tablet)
- Inline validation with real-time feedback
- Clear visual hierarchy
- WCAG AA accessibility compliance
- Professional color palette
- Clear status indicators (green for success, red for errors)
- Loading states for async operations

**Validation Requirements** [Source: PRD Epic 3 Story 3.4 AC 3, 6]:
- Amount validation: positive, <= invoice balance
- Payment date validation: required, not in future
- Reference validation: required, minimum 1 character
- Payment method validation: required, valid enum value
- Real-time validation feedback
- Server-side validation alignment with client-side

**Performance Requirements** [Source: PRD NFR2]:
- Form interactions must be smooth without lag
- Real-time balance calculation must be instant
- API calls should complete within 200ms
- Loading states for operations > 100ms
- Optimistic UI updates where possible

### Coding Standards

**Critical Frontend Rules** [Source: architecture.md#Coding Standards]:
- Use TypeScript interfaces matching backend DTOs exactly
- Never mutate state directly - use Zustand's set function
- Validate in frontend (UX), but also expect backend validation
- Use Shadcn/ui components consistently
- Follow Next.js App Router patterns
- Use React Hook Form for all forms
- Use Zod for validation schemas
- Handle errors gracefully with user-friendly messages
- Implement proper loading states
- Ensure accessibility (ARIA, keyboard navigation)

**Naming Conventions** [Source: architecture.md#Coding Standards]:
- Components: PascalCase (PaymentForm.tsx)
- Hooks: camelCase with 'use' prefix (usePaymentStore.ts)
- Types/Interfaces: PascalCase
- Functions: camelCase
- Constants: SCREAMING_SNAKE_CASE

**Form Patterns**:
- Use React Hook Form for all forms
- Use Zod for validation schemas
- Provide real-time validation feedback
- Show field errors below inputs
- Disable submit button when form invalid
- Show loading state during submission
- Clear form on successful submission
- Handle API errors gracefully

**Error Handling**:
- Show user-friendly error messages
- Use toast notifications for feedback
- Log errors to console in development
- Don't expose technical details to users
- Provide actionable error messages
- Handle network errors gracefully

**Accessibility Requirements**:
- All form fields have labels
- Use ARIA attributes appropriately
- Support keyboard navigation (Tab, Enter, Escape)
- Ensure color contrast meets WCAG AA
- Announce errors to screen readers
- Focus management in dialogs
- Tooltips for disabled states

## Testing
- Component tests for PaymentForm with React Testing Library
- Test form renders with invoice data
- Test form validation rules (amount, date, reference)
- Test real-time balance calculation updates
- Test payment method dropdown options
- Test form submission calls API correctly
- Test success callback called after submission
- Test error handling shows toast notifications
- Test dialog closes on success
- Test form resets on dialog close
- Test disabled states for Draft and Paid invoices
- Test keyboard navigation (Tab, Enter, Escape)
- Test accessibility (ARIA labels, screen reader support)
- E2E test for complete payment recording flow
- Test invoice detail page shows payment button
- Test payment button disabled for Draft invoices
- Test payment button disabled for Paid invoices
- Test invoice updates after payment recorded
- Test success notification appears
- Minimum 85% code coverage on PaymentForm component

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-08 | v1.0 | Initial story creation from PRD Epic 3 Story 3.4 | Claude (Story Agent) |

## Dev Agent Record

### Agent Model Used
Not yet implemented

### Debug Log References
None yet - will be populated during implementation

### Completion Notes List
None yet - will be populated during implementation

### File List
None yet - will be populated during implementation

## QA Results
Not yet reviewed
