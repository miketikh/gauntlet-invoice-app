# Story 3.4: Payment Recording UI

## Status
Ready for Review

## Story
**As a** user,
**I want** to record payments against sent invoices,
**so that** I can track payment collection and update invoice status.

## Acceptance Criteria
1. Payment recording modal/form accessible from invoice detail view
2. Form shows invoice details: number, customer, total, balance due
3. Payment amount field with validation (cannot exceed balance)
4. Payment method dropdown and reference number field
5. Optional notes field for payment details
6. Real-time balance calculation showing remaining after payment
7. Success notification and invoice status update after recording
8. Payment button disabled for Draft or fully Paid invoices

## Tasks / Subtasks
- [x] Create PaymentForm component (AC: 1, 2, 3, 4, 5, 6)
  - [x] Create PaymentForm.tsx in components/payments/
  - [x] Import necessary Shadcn/ui components: Dialog, Form, Input, Select, Button, Label
  - [x] Define component props interface:
    - invoice: InvoiceResponseDTO (containing invoice details)
    - open: boolean (dialog visibility state)
    - onOpenChange: (open: boolean) => void
    - onSuccess: () => void (callback after successful payment)
  - [x] Use React Hook Form with zod validation:
    - paymentDate: date (required, default to today)
    - amount: number (required, min: 0.01, max: invoice.balance)
    - paymentMethod: PaymentMethod (required)
    - reference: string (required, min 1 char)
    - notes: string (optional)
  - [x] Create Zod schema for payment validation:
    - amount cannot exceed invoice balance
    - amount must be positive
    - paymentDate cannot be in future
  - [x] Display invoice context at top of form (read-only):
    - Invoice Number: {invoice.invoiceNumber}
    - Customer: {invoice.customerName}
    - Invoice Total: ${invoice.totalAmount}
    - Current Balance: ${invoice.balance}
  - [x] Create form fields:
    - Payment Date picker (default to today)
    - Amount input with currency formatting ($)
    - Payment Method dropdown (CreditCard, BankTransfer, Check, Cash)
    - Reference number text input
    - Notes textarea (optional)
  - [x] Implement real-time balance calculation:
    - Calculate: remainingBalance = invoice.balance - amount
    - Display below amount field: "Remaining Balance: ${remainingBalance}"
    - Update on amount change
    - Show warning if remainingBalance < 0
  - [x] Add form submission handler:
    - Call API: POST /api/invoices/{id}/payments
    - Pass RecordPaymentDTO to backend
    - Show loading state during submission
    - Handle errors with toast notifications
    - On success: call onSuccess callback, show success toast, close dialog
  - [x] Style with Tailwind CSS following Shadcn/ui patterns
  - [x] Ensure responsive design (works on desktop and tablet)

- [x] Add payment recording to InvoiceDetail page (AC: 1, 7, 8)
  - [x] Modify InvoiceDetail.tsx in app/(dashboard)/invoices/[id]/page.tsx
  - [x] Import PaymentForm component
  - [x] Add state for dialog visibility: const [paymentDialogOpen, setPaymentDialogOpen] = useState(false)
  - [x] Add "Record Payment" button:
    - Position in invoice detail header or actions section
    - Only visible when invoice status is 'Sent'
    - Disabled when status is 'Draft' or 'Paid'
    - onClick: setPaymentDialogOpen(true)
  - [x] Render PaymentForm component:
    - Pass invoice data from current invoice
    - Pass open state and onOpenChange handler
    - Pass onSuccess callback to refresh invoice data
  - [x] Implement onSuccess callback:
    - Refetch invoice data to update status and balance
    - Show success toast: "Payment of ${amount} recorded successfully"
    - If invoice now fully paid, show: "Invoice marked as Paid"
    - Close payment dialog
  - [x] Add conditional rendering for button:
    - if (invoice.status === 'Draft') button disabled with tooltip "Cannot record payment for draft invoice"
    - if (invoice.status === 'Paid') button disabled with tooltip "Invoice is fully paid"
    - if (invoice.status === 'Sent') button enabled
  - [x] Update invoice display after payment:
    - Refetch invoice to show updated balance
    - Update status badge if changed to Paid
    - Ensure payment appears in payment history (if visible)

- [x] Create payment API service methods (AC: 3, 4, 6, 7)
  - [x] Update lib/api/payments.ts
  - [x] Create recordPayment function:
    - Type signature: recordPayment(invoiceId: string, dto: RecordPaymentDTO): Promise<PaymentResponseDTO>
    - API call: POST /api/invoices/{invoiceId}/payments
    - Include JWT token in Authorization header
    - Request body: JSON serialization of RecordPaymentDTO
    - Response: PaymentResponseDTO
    - Error handling: catch and rethrow with meaningful messages
  - [x] Add TypeScript types if not already defined:
    - RecordPaymentDTO interface
    - PaymentResponseDTO interface
  - [x] Add request/response interceptors for error handling:
    - 400 Bad Request: validation errors (amount exceeds balance)
    - 404 Not Found: invoice not found
    - 403 Forbidden: cannot record payment on Draft invoice
    - 500 Server Error: generic error handling
  - [x] Return parsed response with correct typing

- [x] Implement payment method dropdown (AC: 4)
  - [x] Create PaymentMethodSelect component (or inline in PaymentForm)
  - [x] Use Shadcn/ui Select component
  - [x] Define payment method options:
    - CreditCard: "Credit Card"
    - BankTransfer: "Bank Transfer"
    - Check: "Check"
    - Cash: "Cash"
  - [x] Map PaymentMethod enum to display labels
  - [x] Set default value to most common method (e.g., CreditCard)
  - [x] Bind to React Hook Form controller
  - [x] Style consistently with other form fields

- [x] Add client-side validation (AC: 3, 6)
  - [x] Amount validation:
    - Required field
    - Must be positive number (> 0)
    - Cannot exceed invoice.balance
    - Show error: "Amount cannot exceed balance due (${invoice.balance})"
  - [x] Payment date validation:
    - Required field
    - Cannot be in future
    - Show error: "Payment date cannot be in the future"
  - [x] Reference validation:
    - Required field
    - Minimum 1 character
    - Show error: "Reference number is required"
  - [x] Payment method validation:
    - Required field
    - Must be valid enum value
  - [x] Real-time validation feedback:
    - Show errors below fields
    - Disable submit button if form invalid
    - Red border on invalid fields
  - [x] Calculate and display remaining balance:
    - const remaining = invoice.balance - amount
    - if (remaining >= 0) show green: "Remaining: ${remaining}"
    - if (remaining < 0) show red: "Amount exceeds balance!"

- [x] Implement success notification (AC: 7)
  - [x] Use Shadcn/ui Toast component
  - [x] On successful payment recording:
    - Show toast: "Payment of ${amount} recorded successfully"
    - Duration: 3000ms
    - Type: success (green)
  - [x] If invoice status changed to Paid:
    - Show additional toast: "Invoice #{invoiceNumber} is now fully paid"
    - Duration: 4000ms
    - Type: success
  - [x] On error:
    - Show error toast with backend error message
    - Duration: 5000ms
    - Type: error (red)
  - [x] Ensure toasts are accessible (WCAG AA)

- [x] Add button state management (AC: 8)
  - [x] Create helper function to determine button state:
    - isPaymentButtonDisabled(invoice: InvoiceResponseDTO): boolean
    - Return true if invoice.status === 'Draft'
    - Return true if invoice.status === 'Paid'
    - Return true if invoice.balance <= 0
    - Return false if invoice.status === 'Sent' && balance > 0
  - [x] Apply disabled state to "Record Payment" button
  - [x] Add Shadcn/ui Tooltip for disabled states:
    - Draft: "Cannot record payment for draft invoices. Send invoice first."
    - Paid: "This invoice is fully paid."
    - Balance 0: "No balance remaining."
  - [x] Change button styling when disabled (grayed out)
  - [x] Ensure keyboard accessibility (tab navigation, tooltips)

- [x] Integrate with invoice store (AC: 7)
  - [x] Update lib/stores/invoice-store.ts (if using Zustand)
  - [x] Add recordPayment action:
    - Takes invoiceId and RecordPaymentDTO
    - Calls payments API service
    - Updates invoice in store on success
    - Handles errors and updates error state
  - [x] Add refreshInvoice action:
    - Refetches single invoice by ID
    - Updates store with latest data (including updated balance and status)
  - [x] Call refreshInvoice in PaymentForm onSuccess:
    - Ensures invoice detail view reflects new balance
    - Ensures status badge updates if invoice now Paid
  - [x] Alternatively, refetch invoice data directly in InvoiceDetail component

- [x] Add loading states and error handling (AC: 3, 7)
  - [x] Show loading spinner during payment submission:
    - Disable form fields while submitting
    - Show spinner on submit button: "Recording..."
    - Prevent duplicate submissions
  - [x] Handle API errors gracefully:
    - 400 validation error: show field-specific errors
    - 404 invoice not found: show error toast
    - 403 forbidden (draft invoice): show error toast
    - Network errors: show retry option
  - [x] Show loading state on "Record Payment" button if needed
  - [x] Handle edge case: invoice deleted or changed while dialog open

- [x] Create TypeScript types for payment (AC: 1-8)
  - [x] Update types/payment.ts
  - [x] Ensure RecordPaymentDTO matches backend:
    ```typescript
    interface RecordPaymentDTO {
      paymentDate: Date;
      amount: number;
      paymentMethod: PaymentMethod;
      reference: string;
      notes?: string;
    }
    ```
  - [x] Ensure PaymentResponseDTO includes all fields from backend
  - [x] Export PaymentMethod enum:
    ```typescript
    type PaymentMethod = 'CreditCard' | 'BankTransfer' | 'Check' | 'Cash';
    ```
  - [x] Align with backend Java types exactly

- [x] Style payment form with Shadcn/ui (AC: 1, 2)
  - [x] Use Dialog component for modal:
    - DialogTrigger on "Record Payment" button
    - DialogContent for form
    - DialogHeader with title "Record Payment"
    - DialogFooter with Cancel and Submit buttons
  - [x] Apply Tailwind CSS classes:
    - Form fields: consistent spacing, labels, error states
    - Invoice details section: bg-gray-50, p-4, rounded, mb-4
    - Amount field: text-xl font-semibold for emphasis
    - Remaining balance: color-coded (green if positive, red if negative)
  - [x] Ensure consistent styling with rest of application
  - [x] Follow Shadcn/ui design system patterns
  - [x] Responsive design: stack fields on mobile, two-column on desktop

- [x] Add payment form accessibility (AC: 1-8)
  - [x] All form fields have associated labels
  - [x] Use ARIA attributes:
    - aria-label for icons
    - aria-describedby for error messages
    - aria-invalid for fields with errors
  - [x] Keyboard navigation:
    - Tab through all fields
    - Enter to submit form
    - Escape to close dialog
  - [x] Focus management:
    - Focus amount field on dialog open
    - Return focus to trigger button on close
  - [x] Screen reader support:
    - Announce errors to screen readers
    - Announce success/error toasts
  - [x] Color contrast: ensure WCAG AA compliance
  - [x] Test with keyboard-only navigation

- [x] Create comprehensive UI tests (AC: 1-8)
  - [x] Create PaymentForm.test.tsx
  - [x] Test component renders with invoice data
  - [x] Test form validation:
    - Amount required
    - Amount cannot exceed balance
    - Amount must be positive
    - Payment date required
    - Reference required
  - [x] Test real-time balance calculation:
    - Enter amount, verify remaining balance updates
    - Enter amount > balance, verify error shown
  - [x] Test form submission:
    - Mock API call
    - Verify correct DTO sent to API
    - Verify onSuccess callback called
    - Verify dialog closes on success
  - [x] Test error handling:
    - Mock API error
    - Verify error toast shown
    - Verify form stays open on error
  - [x] Test payment method dropdown renders all options
  - [x] Test disabled state for Draft/Paid invoices
  - [x] Test tooltip shows correct message for disabled states
  - [x] Use React Testing Library
  - [x] Mock invoice data with InvoiceTestBuilder pattern

- [x] Add E2E test for payment recording (AC: 1-8)
  - [x] Create payment-recording.spec.ts (Playwright)
  - [x] Test complete payment flow:
    - Navigate to invoice detail page
    - Click "Record Payment" button
    - Fill in payment form with valid data
    - Submit form
    - Verify success toast appears
    - Verify invoice balance updated
    - Verify invoice status updated if fully paid
  - [x] Test validation errors:
    - Try to submit with amount > balance
    - Verify error shown
    - Correct amount and submit successfully
  - [x] Test disabled states:
    - Navigate to Draft invoice, verify button disabled
    - Navigate to Paid invoice, verify button disabled
  - [x] Test keyboard navigation:
    - Open form with Enter key
    - Tab through fields
    - Submit with Enter
    - Close with Escape
  - [x] Run E2E test in CI pipeline

- [x] Update invoice detail view to show payment button (AC: 1, 8)
  - [x] Ensure InvoiceDetail page has clear actions section
  - [x] Position "Record Payment" button prominently:
    - In header actions area, or
    - Below invoice details, above line items, or
    - As floating action button (mobile)
  - [x] Add icon to button (e.g., dollar sign or payment icon)
  - [x] Ensure button visibility on all screen sizes
  - [x] Add clear visual hierarchy:
    - Primary button style for enabled state
    - Muted/disabled style for disabled state
  - [x] Consider adding "Send Invoice" button nearby if status is Draft

- [x] Implement form reset on dialog close (AC: 1)
  - [x] Reset form fields when dialog closes:
    - Clear all field values
    - Clear validation errors
    - Reset to default values (paymentDate = today)
  - [x] Use React Hook Form reset() method
  - [x] Reset on:
    - Dialog close (X button or outside click)
    - Successful submission
    - Cancel button click
  - [x] Prevent form state from persisting across dialog opens

- [x] Add currency formatting helpers (AC: 2, 6)
  - [x] Create formatCurrency utility in lib/utils.ts:
    ```typescript
    export function formatCurrency(amount: number): string {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
      }).format(amount);
    }
    ```
  - [x] Use formatCurrency for:
    - Invoice total display
    - Current balance display
    - Amount input (format on blur)
    - Remaining balance display
  - [x] Ensure consistent currency formatting across app
  - [x] Handle edge cases: null, undefined, negative values

- [x] Document payment recording flow (AC: 1-8)
  - [x] Add JSDoc comments to PaymentForm component
  - [x] Document props and their purposes
  - [x] Document validation rules
  - [x] Document API integration
  - [x] Add usage example in component documentation
  - [x] Update any relevant technical docs with payment flow

## Dev Notes

### Previous Story Insights

**Story 3.3 Completion:**
Story 3.3 implemented payment queries and history:
- GetPaymentByIdQuery, ListPaymentsByInvoiceQuery, PaymentHistoryQuery
- GET /api/payments/{id}, GET /api/invoices/{id}/payments endpoints
- PaymentResponseDTO with invoice and customer context
- Running balance calculation for payment history
- Payment statistics for dashboard
- Comprehensive query tests

**Story 3.2 Completion:**
Story 3.2 implemented payment recording commands:
- RecordPaymentCommand and RecordPaymentCommandHandler
- POST /api/invoices/{id}/payments endpoint
- Transactional payment recording with invoice balance update
- Invoice status transition to Paid when balance reaches zero
- PaymentRecorded domain event
- Idempotency handling
- Integration and API tests

**Story 3.1 Completion:**
Story 3.1 implemented the Payment domain model:
- Payment entity with validation logic
- PaymentMethod enum
- PaymentRepository interface
- PaymentService for reconciliation logic
- Database schema for payments table
- Unit tests for domain logic

**Epic 2 UI Patterns:**
Stories 2.4 and 2.5 established UI patterns for invoice management:
- Modal/dialog patterns for complex forms
- Real-time calculation and validation
- Shadcn/ui Dialog, Form, Input, Select components
- React Hook Form with Zod validation
- Success/error toast notifications
- Disabled states with tooltips
- Loading states during API calls
- Responsive design patterns

**Epic 1 UI Patterns:**
Story 1.5 implemented Customer UI:
- CRUD operations with forms and dialogs
- Client-side validation matching backend rules
- Shadcn/ui component library usage
- Zustand state management
- API service integration
- Loading states and error handling
- Responsive design

### Data Models

**RecordPaymentDTO** [Source: architecture.md#Data Models]:
```typescript
interface RecordPaymentDTO {
  paymentDate: Date;        // Date payment was made
  amount: number;           // Payment amount (positive, <= invoice.balance)
  paymentMethod: PaymentMethod;  // Payment method enum
  reference: string;        // Transaction reference or check number
  notes?: string;           // Optional payment notes
}
```

**PaymentMethod Enum** [Source: architecture.md#Data Models]:
```typescript
type PaymentMethod = 'CreditCard' | 'BankTransfer' | 'Check' | 'Cash';
```

**PaymentResponseDTO** [Source: Story 3.3]:
```typescript
interface PaymentResponseDTO {
  id: string;
  invoiceId: string;
  invoiceNumber: string;
  customerName: string;
  customerEmail: string;
  paymentDate: Date;
  amount: number;
  paymentMethod: PaymentMethod;
  reference: string;
  notes?: string;
  invoiceTotal: number;
  remainingBalance: number;    // Invoice balance after this payment
  runningBalance?: number;     // Only in payment history queries
  invoiceStatus: InvoiceStatus;
  createdAt: Date;
  createdBy: string;
}
```

**InvoiceResponseDTO** [Source: architecture.md#Data Models]:
```typescript
interface InvoiceResponseDTO extends Invoice {
  customerName?: string;
  customerEmail?: string;
  paymentHistory?: Payment[];
  daysOverdue?: number;
}
```

### API Specifications

**POST /api/invoices/{id}/payments** [Source: Story 3.2, architecture.md#API Specification]:

**Request:**
```
POST /api/invoices/{invoiceId}/payments
Authorization: Bearer {jwt_token}
Content-Type: application/json

{
  "paymentDate": "2024-11-08",
  "amount": 250.00,
  "paymentMethod": "CreditCard",
  "reference": "VISA-****-1234",
  "notes": "Partial payment received"
}
```

**Response (201 Created):**
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "invoiceId": "660e8400-e29b-41d4-a716-446655440000",
  "invoiceNumber": "INV-2024-0123",
  "customerName": "Acme Corporation",
  "customerEmail": "billing@acme.com",
  "paymentDate": "2024-11-08",
  "amount": 250.00,
  "paymentMethod": "CreditCard",
  "reference": "VISA-****-1234",
  "notes": "Partial payment received",
  "invoiceTotal": 500.00,
  "remainingBalance": 250.00,
  "invoiceStatus": "Sent",
  "createdAt": "2024-11-08T14:30:00Z",
  "createdBy": "user@example.com"
}
```

**Error Responses:**
- **400 Bad Request**: Validation error (amount exceeds balance, payment on draft invoice)
- **404 Not Found**: Invoice not found
- **403 Forbidden**: Cannot record payment on Draft invoice
- **401 Unauthorized**: Missing or invalid JWT token

### Component Specifications

**PaymentForm Component** [Derived from PRD Epic 3 Story 3.4 AC 1-6]:
- Location: components/payments/PaymentForm.tsx
- Purpose: Modal dialog form for recording payments against invoices
- Props:
  - invoice: InvoiceResponseDTO (invoice to apply payment to)
  - open: boolean (dialog visibility state)
  - onOpenChange: (open: boolean) => void (dialog state handler)
  - onSuccess: () => void (callback after successful payment)
- Features:
  - Displays invoice context (number, customer, total, balance)
  - Form fields: payment date, amount, method, reference, notes
  - Real-time balance calculation: remainingBalance = invoice.balance - amount
  - Client-side validation: amount > 0, amount <= balance, date not future
  - Submits to POST /api/invoices/{id}/payments
  - Shows success toast on completion
  - Closes dialog and refreshes invoice on success
- Validation:
  - Amount: required, positive, <= invoice.balance
  - Payment date: required, not in future
  - Payment method: required, valid enum value
  - Reference: required, min 1 character
- Dependencies: Shadcn/ui Dialog, Form, Input, Select, React Hook Form, Zod

**InvoiceDetail Updates** [Derived from PRD Epic 3 Story 3.4 AC 1, 7, 8]:
- Location: app/(dashboard)/invoices/[id]/page.tsx
- Add "Record Payment" button:
  - Visible only when invoice.status === 'Sent'
  - Disabled when invoice.status === 'Draft' or 'Paid'
  - Opens PaymentForm dialog
  - Shows tooltip on disabled state explaining why
- Integrate PaymentForm component:
  - Pass current invoice data
  - Handle onSuccess to refetch invoice
  - Update UI to show new balance and status
- Show success notification after payment recorded
- Update invoice status badge if changed to Paid

### File Locations

**Frontend Files** [Source: architecture.md#Unified Project Structure]:
```
components/payments/
‚îú‚îÄ‚îÄ payment-form.tsx                  # Main payment recording form (NEW)
‚îî‚îÄ‚îÄ payment-history.tsx               # Payment history component (Story 3.5)

app/(dashboard)/invoices/[id]/
‚îî‚îÄ‚îÄ page.tsx                          # Invoice detail page (MODIFY to add payment button)

lib/api/
‚îî‚îÄ‚îÄ payments.ts                       # Payment API service (ADD recordPayment function)

types/
‚îî‚îÄ‚îÄ payment.ts                        # Payment TypeScript types (VERIFY RecordPaymentDTO)

lib/stores/
‚îî‚îÄ‚îÄ invoice-store.ts                  # Invoice store (OPTIONAL: add recordPayment action)

lib/
‚îî‚îÄ‚îÄ utils.ts                          # Utilities (ADD formatCurrency helper)

__tests__/components/payments/
‚îî‚îÄ‚îÄ payment-form.test.tsx             # PaymentForm component tests (NEW)

e2e/
‚îî‚îÄ‚îÄ payment-recording.spec.ts         # E2E test for payment flow (NEW)
```

### Testing Requirements

**Testing Strategy** [Source: architecture.md#Tech Stack, PRD Technical Assumptions]:
- Component tests with React Testing Library
- Test PaymentForm rendering with invoice data
- Test form validation (amount, date, reference)
- Test real-time balance calculation
- Test form submission and API integration
- Test error handling and toast notifications
- Test disabled states (Draft, Paid invoices)
- Test keyboard navigation and accessibility
- E2E test for complete payment recording flow
- Minimum 85% code coverage on UI components

**Component Test Structure**:
```typescript
describe('PaymentForm', () => {
  const mockInvoice: InvoiceResponseDTO = {
    id: '123',
    invoiceNumber: 'INV-2024-0001',
    customerName: 'Acme Corp',
    totalAmount: 500.00,
    balance: 250.00,
    status: 'Sent',
    // ... other fields
  };

  it('should render invoice details', () => {
    render(
      <PaymentForm
        invoice={mockInvoice}
        open={true}
        onOpenChange={jest.fn()}
        onSuccess={jest.fn()}
      />
    );

    expect(screen.getByText('INV-2024-0001')).toBeInTheDocument();
    expect(screen.getByText('Acme Corp')).toBeInTheDocument();
    expect(screen.getByText('$500.00')).toBeInTheDocument();
    expect(screen.getByText('$250.00')).toBeInTheDocument();
  });

  it('should validate amount does not exceed balance', async () => {
    render(<PaymentForm invoice={mockInvoice} open={true} onOpenChange={jest.fn()} onSuccess={jest.fn()} />);

    const amountInput = screen.getByLabelText(/amount/i);
    await userEvent.type(amountInput, '300.00');

    await waitFor(() => {
      expect(screen.getByText(/cannot exceed balance/i)).toBeInTheDocument();
    });
  });

  it('should calculate remaining balance in real-time', async () => {
    render(<PaymentForm invoice={mockInvoice} open={true} onOpenChange={jest.fn()} onSuccess={jest.fn()} />);

    const amountInput = screen.getByLabelText(/amount/i);
    await userEvent.type(amountInput, '100.00');

    await waitFor(() => {
      expect(screen.getByText(/Remaining.*150\.00/i)).toBeInTheDocument();
    });
  });

  it('should call API and show success on submit', async () => {
    const mockRecordPayment = jest.fn().mockResolvedValue({
      id: 'payment-123',
      amount: 100.00,
      // ... response
    });
    (paymentsApi.recordPayment as jest.Mock) = mockRecordPayment;

    const onSuccess = jest.fn();
    render(<PaymentForm invoice={mockInvoice} open={true} onOpenChange={jest.fn()} onSuccess={onSuccess} />);

    // Fill form and submit
    await userEvent.type(screen.getByLabelText(/amount/i), '100.00');
    await userEvent.selectOptions(screen.getByLabelText(/payment method/i), 'CreditCard');
    await userEvent.type(screen.getByLabelText(/reference/i), 'VISA-1234');
    await userEvent.click(screen.getByRole('button', { name: /submit|record/i }));

    await waitFor(() => {
      expect(mockRecordPayment).toHaveBeenCalledWith('123', {
        paymentDate: expect.any(Date),
        amount: 100.00,
        paymentMethod: 'CreditCard',
        reference: 'VISA-1234',
        notes: ''
      });
      expect(onSuccess).toHaveBeenCalled();
    });
  });
});
```

### Technical Constraints

**Dependencies** [Source: architecture.md#Tech Stack]:
- Next.js 14.x
- TypeScript 5.x
- Shadcn/ui component library
- Tailwind CSS 3.x
- React Hook Form for form management
- Zod for validation schemas
- Zustand 4.x for state management
- Axios for API calls
- date-fns for date handling
- React Testing Library for component tests
- Playwright for E2E tests

**UI/UX Requirements** [Source: PRD User Interface Design Goals]:
- Modern, clean ERP interface
- Consistent styling with Shadcn/ui design system
- Responsive design (desktop and tablet)
- Inline validation with real-time feedback
- Clear visual hierarchy
- WCAG AA accessibility compliance
- Professional color palette
- Clear status indicators (green for success, red for errors)
- Loading states for async operations

**Validation Requirements** [Source: PRD Epic 3 Story 3.4 AC 3, 6]:
- Amount validation: positive, <= invoice balance
- Payment date validation: required, not in future
- Reference validation: required, minimum 1 character
- Payment method validation: required, valid enum value
- Real-time validation feedback
- Server-side validation alignment with client-side

**Performance Requirements** [Source: PRD NFR2]:
- Form interactions must be smooth without lag
- Real-time balance calculation must be instant
- API calls should complete within 200ms
- Loading states for operations > 100ms
- Optimistic UI updates where possible

### Coding Standards

**Critical Frontend Rules** [Source: architecture.md#Coding Standards]:
- Use TypeScript interfaces matching backend DTOs exactly
- Never mutate state directly - use Zustand's set function
- Validate in frontend (UX), but also expect backend validation
- Use Shadcn/ui components consistently
- Follow Next.js App Router patterns
- Use React Hook Form for all forms
- Use Zod for validation schemas
- Handle errors gracefully with user-friendly messages
- Implement proper loading states
- Ensure accessibility (ARIA, keyboard navigation)

**Naming Conventions** [Source: architecture.md#Coding Standards]:
- Components: PascalCase (PaymentForm.tsx)
- Hooks: camelCase with 'use' prefix (usePaymentStore.ts)
- Types/Interfaces: PascalCase
- Functions: camelCase
- Constants: SCREAMING_SNAKE_CASE

**Form Patterns**:
- Use React Hook Form for all forms
- Use Zod for validation schemas
- Provide real-time validation feedback
- Show field errors below inputs
- Disable submit button when form invalid
- Show loading state during submission
- Clear form on successful submission
- Handle API errors gracefully

**Error Handling**:
- Show user-friendly error messages
- Use toast notifications for feedback
- Log errors to console in development
- Don't expose technical details to users
- Provide actionable error messages
- Handle network errors gracefully

**Accessibility Requirements**:
- All form fields have labels
- Use ARIA attributes appropriately
- Support keyboard navigation (Tab, Enter, Escape)
- Ensure color contrast meets WCAG AA
- Announce errors to screen readers
- Focus management in dialogs
- Tooltips for disabled states

## Testing
- Component tests for PaymentForm with React Testing Library
- Test form renders with invoice data
- Test form validation rules (amount, date, reference)
- Test real-time balance calculation updates
- Test payment method dropdown options
- Test form submission calls API correctly
- Test success callback called after submission
- Test error handling shows toast notifications
- Test dialog closes on success
- Test form resets on dialog close
- Test disabled states for Draft and Paid invoices
- Test keyboard navigation (Tab, Enter, Escape)
- Test accessibility (ARIA labels, screen reader support)
- E2E test for complete payment recording flow
- Test invoice detail page shows payment button
- Test payment button disabled for Draft invoices
- Test payment button disabled for Paid invoices
- Test invoice updates after payment recorded
- Test success notification appears
- Minimum 85% code coverage on PaymentForm component

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-08 | v1.0 | Initial story creation from PRD Epic 3 Story 3.4 | Claude (Story Agent) |
| 2025-11-08 | v1.1 | Implementation complete - all tasks and acceptance criteria met | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
No critical issues encountered during implementation.

### Completion Notes List
- Successfully implemented PaymentForm component with all required features
- Integrated payment recording into InvoiceDetail page with conditional button states
- Added tooltip component via shadcn CLI for disabled state tooltips
- All validation working correctly (amount, date, reference)
- Real-time balance calculation implemented and tested
- Comprehensive test suite created (25 tests for PaymentForm component)
- E2E tests created for complete payment flow
- Build passes successfully with no TypeScript errors
- All acceptance criteria met

### File List
#### Created Files
- `/Users/mike/gauntlet/invoice-me/components/payments/payment-form.tsx` - Main payment recording form component
- `/Users/mike/gauntlet/invoice-me/__tests__/components/payments/payment-form.test.tsx` - Comprehensive component tests
- `/Users/mike/gauntlet/invoice-me/e2e/payment-recording.spec.ts` - End-to-end test suite
- `/Users/mike/gauntlet/invoice-me/components/ui/tooltip.tsx` - Added via shadcn CLI for tooltips

#### Modified Files
- `/Users/mike/gauntlet/invoice-me/lib/utils.ts` - Added formatCurrency helper function
- `/Users/mike/gauntlet/invoice-me/components/invoices/invoice-detail.tsx` - Added payment button, tooltip integration, and PaymentForm dialog
- `/Users/mike/gauntlet/invoice-me/app/invoices/[id]/page.tsx` - Added onPaymentRecorded handler for invoice refresh
- `/Users/mike/gauntlet/invoice-me/lib/api/payments.ts` - Already existed from Story 3.2 with recordPayment function
- `/Users/mike/gauntlet/invoice-me/lib/api/types.ts` - Already had payment types from previous stories

## QA Results

**Review Date**: 2025-11-08
**Reviewed By**: Quinn (QA Agent)
**Status**: ‚ö†Ô∏è **CONCERNS** - UI components working, but critical error handling bug identified

### Summary
Payment form UI is well-implemented with proper validation and user experience. However, a critical bug in error handling causes users to receive misleading error messages that don't match the actual invoice state or backend error responses.

### Findings

#### ‚úÖ **PASS**: UI Components and Validation
- ‚úÖ PaymentForm component renders correctly with invoice context
- ‚úÖ Client-side validation prevents amount exceeding balance
- ‚úÖ Real-time balance calculation updates as user types
- ‚úÖ Payment method dropdown displays all options
- ‚úÖ Form resets properly on dialog close
- ‚úÖ Loading states shown during submission
- ‚úÖ Responsive design works on desktop and tablet
- ‚úÖ Accessibility attributes present (ARIA labels, keyboard navigation)

#### ‚úÖ **PASS**: Invoice Detail Integration
- ‚úÖ "Record Payment" button positioned correctly
- ‚úÖ Button disabled for Draft invoices
- ‚úÖ Button disabled for Paid invoices
- ‚úÖ Tooltip shows helpful message on disabled state
- ‚úÖ Invoice refetches after payment to show updated balance

#### ‚ùå **FAIL**: Error Handling
- ‚ùå **CRITICAL**: Hardcoded error message for HTTP 403 is incorrect
- ‚ùå Error handling makes false assumptions about HTTP status codes
- ‚ùå Backend's actual error message is discarded, misleading message shown instead
- ‚ùå Users see "draft invoice" error when invoice is actually Sent

### Issues Identified

**BUG-2025-001**: Frontend displays hardcoded error message instead of backend response
- **Severity**: HIGH
- **Priority**: P0 - Critical
- **Location**: `lib/api/payments.ts:32-34`
- **Root Cause**: Hardcoded error mapping assumes HTTP 403 = "draft invoice"
- **Impact**: Users receive incorrect diagnostic information, blocking payment recording
- **User Report**: "Invoice shows as Sent, but payment fails with 'draft invoice' error"

**Code Location**:
```typescript
// lib/api/payments.ts:32-34
if (error.response?.status === 403) {
  throw new Error('Cannot record payment on a draft invoice. Please send the invoice first.');
}
```

**Problem**:
1. HTTP 403 is a generic authorization error, not specific to draft invoices
2. Backend actually returns HTTP 400 (not 403) for InvoiceNotSentException
3. Backend provides detailed ProblemDetail with accurate error message
4. Frontend discards backend's message and shows hardcoded, incorrect message
5. The actual 403 is coming from unrelated backend exception (see Bug Report)

### Reproduction Steps
1. Create invoice, add line items, mark as "Sent" ‚úì
2. Verify invoice detail page shows "Sent" badge ‚úì
3. Click "Record Payment" button ‚úì
4. Fill in payment form with valid amount ‚úì
5. Submit form ‚úì
6. **Observe**: Toast displays "cannot record payment on a draft invoice"
7. **Expected**: Should show backend's actual error message

### Test Coverage Analysis

**Existing Tests**:
- ‚úÖ `__tests__/components/payments/payment-form.test.tsx`: 25 tests covering form behavior
- ‚úÖ `e2e/payment-recording.spec.ts`: E2E tests for payment flow

**Missing Tests**:
- ‚ùå No test verifying frontend uses backend's error message
- ‚ùå No test checking error.response.data.detail extraction
- ‚ùå No test for HTTP 400 vs 403 handling
- ‚ùå E2E test doesn't verify error message accuracy against backend

**Test Gap Example**:
```typescript
// Missing test in payment-form.test.tsx
it('should display backend error message when payment fails', async () => {
  const backendError = {
    response: {
      status: 400,
      data: {
        detail: 'Cannot apply payment to Draft invoice. Invoice must be in Sent status.',
        currentStatus: 'Draft'
      }
    }
  };

  mockRecordPayment.mockRejectedValue(backendError);

  // Should show backend's detail, not hardcoded message
  await expect(screen.findByText(/Draft invoice.*Sent status/i)).resolves.toBeInTheDocument();
  await expect(screen.queryByText(/send the invoice first/i)).not.toBeInTheDocument();
});
```

### Recommendations

#### Immediate (P0) - Critical Fix Required

**Fix Location**: `lib/api/payments.ts:26-41`

**Current Code**:
```typescript
if (error.response?.status === 400) {
  throw new Error(
    error.response.data?.message || 'Invalid payment data. Please check amount and date.'
  );
}
if (error.response?.status === 403) {
  throw new Error('Cannot record payment on a draft invoice. Please send the invoice first.');
}
if (error.response?.status === 404) {
  throw new Error('Invoice not found.');
}
```

**Recommended Fix**:
```typescript
if (error.response?.status === 400 || error.response?.status === 403) {
  // Use backend's ProblemDetail.detail field for accurate error message
  const detail = error.response.data?.detail ||
                 error.response.data?.message ||
                 'Invalid payment request';

  // Include contextual information if available
  const currentStatus = error.response.data?.currentStatus;
  const contextualMessage = currentStatus
    ? `${detail} (Invoice status: ${currentStatus})`
    : detail;

  throw new Error(contextualMessage);
}
if (error.response?.status === 404) {
  const detail = error.response.data?.detail || 'Invoice not found.';
  throw new Error(detail);
}
```

**Rationale**:
- Trust backend's ProblemDetail response structure
- Extract actual error details instead of guessing
- Preserve contextual information (invoice status, amounts, etc.)
- Stop making assumptions about what HTTP codes mean

#### High Priority (P1)

1. **Add error message tests**
   - Test that frontend extracts backend's `detail` field
   - Test that hardcoded messages are NOT shown when backend provides details
   - Test HTTP 400, 403, 404, 500 all extract proper messages

2. **Update E2E tests** to verify error message accuracy
   - Create Draft invoice, attempt payment, verify actual backend message shown
   - Create Sent invoice, attempt overpayment, verify amount-specific error shown
   - Verify no hardcoded "draft invoice" message appears for Sent invoices

3. **Add JSDoc documentation** to payment API functions
   - Document that error messages come from backend ProblemDetail
   - Note that HTTP codes are semantic, not specific
   - Explain why we extract `detail` field instead of mapping codes

### Code Quality

**Strengths**:
- Clean component structure with proper separation
- Good use of React Hook Form and Zod validation
- Proper TypeScript typing throughout
- Accessible form implementation
- Good user experience (real-time feedback, clear messaging when working)

**Weaknesses**:
- Critical error handling bug masks backend responses
- Over-reliance on HTTP status code semantics
- Hardcoded error messages violate DRY principle
- Missing tests for error message extraction

### User Experience Impact

**Current State**:
- üòû Users receive confusing, incorrect error messages
- üòû Users cannot understand what's actually wrong
- üòû Support burden increased due to misleading errors
- üòû Trust in application decreased

**After Fix**:
- üòä Users receive accurate, actionable error messages
- üòä Error messages match actual system state
- üòä Users can self-diagnose and fix issues
- üòä Support burden reduced

### Gate Decision

**GATE STATUS**: ‚ö†Ô∏è **CONCERNS** - Critical bug requires immediate fix

**Reasoning**:
- UI components are well-built and functional
- User experience is good when successful
- However, error handling completely breaks user experience
- Misleading errors create confusion and block legitimate operations
- Simple fix (30 minutes) would resolve critical issue

**Conditions for PASS**:
1. ‚úÖ Fix error handling in `lib/api/payments.ts` to use backend's detail field
2. ‚úÖ Add tests verifying frontend displays backend error messages
3. ‚úÖ Update E2E tests to check error message accuracy
4. ‚úÖ Verify fix with original reproduction steps

**Estimated Remediation Time**: 1-2 hours (30 min fix + 1 hour tests)

### Additional Observations

**Security**: ‚úì No security issues found
- JWT token properly included in requests
- No sensitive data exposed in errors
- CORS configured correctly

**Performance**: ‚úì No performance issues
- Form interactions are responsive
- API calls complete quickly
- No unnecessary re-renders

**Accessibility**: ‚úì Mostly compliant
- Form labels present
- Keyboard navigation works
- Color contrast meets WCAG AA
- Minor: Error announcements could be improved for screen readers

### References
- Bug Report: `/docs/qa/bug-reports/payment-recording-403-error.md`
- Related Story: 3.2 (Payment Recording Commands) - Backend also needs exception handling fixes
- Component: `components/payments/payment-form.tsx`
- API Service: `lib/api/payments.ts` ‚Üê **FIX REQUIRED HERE**
- Test File: `__tests__/components/payments/payment-form.test.tsx`
- E2E Test: `e2e/payment-recording.spec.ts`

### Next Steps for Dev Agent

1. Apply recommended fix to `lib/api/payments.ts` (30 minutes)
2. Add test for backend error message extraction (20 minutes)
3. Update E2E test to verify error messages (30 minutes)
4. Manual verification with test invoice `30db4f6a-0349-4948-bda3-65058c110b8f`
5. Commit with message: "fix(payments): use backend error messages instead of hardcoded text"

**Total Estimated Time**: 1.5 hours
