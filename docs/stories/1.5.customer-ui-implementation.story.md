# Story 1.5: Customer UI Implementation

## Status
Draft

## Story
**As a** user,
**I want** to manage customers through a responsive web interface,
**so that** I can perform all CRUD operations efficiently.

## Acceptance Criteria
1. Customer list page with data table showing all customers
2. Search, filter, and sort functionality on customer list
3. Create customer form with client-side validation matching backend rules
4. Edit customer form pre-populated with existing data
5. Delete confirmation dialog with success/error notifications
6. Responsive design working on desktop and tablet
7. Loading states and error handling for all API operations
8. Navigation menu with active state highlighting

## Tasks / Subtasks
- [ ] Create Customer types and API client (AC: 1, 2, 3, 4, 5)
  - [ ] Create Customer TypeScript interfaces in lib/api/types.ts (Customer, CreateCustomerDTO, UpdateCustomerDTO, CustomerResponseDTO)
  - [ ] Create customer API client in lib/api/customers.ts with CRUD operations
  - [ ] Add getCustomers() with pagination, sorting, filtering
  - [ ] Add getCustomerById(id) for single customer retrieval
  - [ ] Add createCustomer(data) for customer creation
  - [ ] Add updateCustomer(id, data) for customer updates
  - [ ] Add deleteCustomer(id) for soft deletion
  - [ ] Integrate with existing API client setup (JWT auth headers)

- [ ] Create Customer Zustand store (AC: 1, 2, 7)
  - [ ] Create customer-store.ts in lib/stores/
  - [ ] Define CustomerStore interface with state and actions
  - [ ] Implement fetchCustomers action with loading/error states
  - [ ] Implement fetchCustomerById action
  - [ ] Implement createCustomer action with optimistic updates
  - [ ] Implement updateCustomer action
  - [ ] Implement deleteCustomer action
  - [ ] Add pagination state (page, size, totalPages, totalElements)
  - [ ] Add filter/search state (searchTerm, sortBy, sortDirection)
  - [ ] Export selector hooks for common use cases

- [ ] Build Customer List component (AC: 1, 2, 7, 8)
  - [ ] Create customer-list.tsx in components/customers/
  - [ ] Build data table using Shadcn/ui Table component
  - [ ] Display columns: name, email, phone, createdAt, actions
  - [ ] Add search input with debounced onChange
  - [ ] Add sort controls (clickable column headers)
  - [ ] Add pagination controls (previous, next, page numbers)
  - [ ] Implement loading skeleton states
  - [ ] Add error boundary and error message display
  - [ ] Add empty state when no customers found
  - [ ] Add action buttons per row (Edit, Delete)
  - [ ] Add "Create Customer" button in header

- [ ] Build Customer Form component (AC: 3, 4, 7)
  - [ ] Create customer-form.tsx in components/customers/
  - [ ] Use React Hook Form for form state management
  - [ ] Add form fields: name, email, phone, address (street, city, state, postalCode, country)
  - [ ] Implement client-side validation (required fields, email format, phone format)
  - [ ] Match validation rules to backend (from Story 1.3)
  - [ ] Add loading state during form submission
  - [ ] Display error messages for validation failures
  - [ ] Display API error messages from backend
  - [ ] Pre-populate form fields for edit mode
  - [ ] Clear form after successful submission
  - [ ] Add Cancel and Submit buttons

- [ ] Build Delete Confirmation Dialog (AC: 5, 7)
  - [ ] Create delete-customer-dialog.tsx in components/customers/
  - [ ] Use Shadcn/ui AlertDialog component
  - [ ] Display customer name in confirmation message
  - [ ] Show loading state during deletion
  - [ ] Handle success with toast notification
  - [ ] Handle errors with toast notification
  - [ ] Close dialog after successful deletion

- [ ] Create Customer List page (AC: 1, 2, 8)
  - [ ] Update app/customers/page.tsx with CustomerList component
  - [ ] Connect to customer store for data fetching
  - [ ] Implement useEffect to fetch customers on mount
  - [ ] Handle search/filter/sort URL query parameters
  - [ ] Update URL when filters change (for bookmarkable state)
  - [ ] Add page title and breadcrumbs
  - [ ] Integrate with layout navigation

- [ ] Create Customer Create/Edit pages (AC: 3, 4, 8)
  - [ ] Create app/customers/new/page.tsx for customer creation
  - [ ] Create app/customers/[id]/page.tsx for customer editing
  - [ ] Use CustomerForm component in create mode
  - [ ] Use CustomerForm component in edit mode with pre-loaded data
  - [ ] Fetch customer data for edit page
  - [ ] Handle success navigation (redirect to list after save)
  - [ ] Add page title and breadcrumbs

- [ ] Implement responsive design (AC: 6)
  - [ ] Test table layout on desktop (1024px+)
  - [ ] Test table layout on tablet (768px-1023px)
  - [ ] Add mobile-responsive table (stack columns or horizontal scroll)
  - [ ] Ensure form is usable on tablet devices
  - [ ] Test touch interactions for mobile/tablet
  - [ ] Verify all buttons and links are appropriately sized

- [ ] Add navigation integration (AC: 8)
  - [ ] Update navigation menu to include Customers link
  - [ ] Add active state styling for current route
  - [ ] Ensure navigation works from all customer pages
  - [ ] Test navigation between customer list, create, edit pages

- [ ] Write comprehensive tests (AC: 7)
  - [ ] Unit tests for customer API client (mock fetch)
  - [ ] Unit tests for customer store (all actions)
  - [ ] Component tests for CustomerList (rendering, search, pagination)
  - [ ] Component tests for CustomerForm (validation, submission)
  - [ ] Component tests for DeleteDialog (confirmation, cancellation)
  - [ ] Integration tests for customer pages (navigation flow)
  - [ ] Test error handling scenarios (API failures, network errors)
  - [ ] Test loading states render correctly
  - [ ] E2E tests for complete CRUD flow (optional)

## Dev Notes

### Previous Story Insights
Story 1.4 (Customer Queries & API Integration) implements the backend query operations providing GET /api/customers and GET /api/customers/{id} endpoints with pagination, sorting, and filtering. Story 1.3 implements the command operations with POST, PUT, and DELETE endpoints. This story builds the frontend UI to consume these APIs.

**Key Learnings from Story 1.2 (Authentication):**
- JWT authentication is configured and working
- All API requests require Bearer token in Authorization header
- API client in lib/api/client.ts handles token injection automatically
- Zustand store pattern established with auth-store.ts
- Protected routes use middleware.ts for authentication checks

**Key Learnings from Story 1.3 (Customer Commands):**
- Customer entity has fields: id, name, email, phone, address (embedded Address object)
- Address object: street, city, state, postalCode, country
- Soft delete implemented with isDeleted flag
- Validation rules: name required, email required and unique, phone optional, address optional

**Key Learnings from Story 1.4 (Customer Queries):**
- Pagination implemented with Spring Data Pageable
- Search supports filtering by name or email (case-insensitive contains)
- Sort fields: name, email, createdAt
- CustomerResponseDTO includes computed fields: totalInvoices, outstandingBalance
- API returns paginated response with metadata (totalElements, totalPages, size, number, etc.)

### Data Models

**Customer TypeScript Interfaces** [Source: architecture.md#Data Models - Customer]:
```typescript
// Customer domain model
interface Customer {
  id: string;
  name: string;
  email: string;
  phone: string;
  address: Address;
  createdAt: Date;
  updatedAt: Date;
  isDeleted: boolean;
}

interface Address {
  street: string;
  city: string;
  state: string;
  postalCode: string;
  country: string;
}

// DTOs for API operations
interface CreateCustomerDTO {
  name: string;
  email: string;
  phone: string;
  address: Address;
}

interface UpdateCustomerDTO {
  name: string;
  email: string;
  phone: string;
  address: Address;
}

// Response DTO with computed fields
interface CustomerResponseDTO extends Customer {
  totalInvoices?: number;
  outstandingBalance?: number;
}

// List item DTO (lighter than full response)
interface CustomerListItemDTO {
  id: string;
  name: string;
  email: string;
  phone: string;
  createdAt: Date;
  totalInvoices?: number;
  outstandingBalance?: number;
}

// Paginated response from backend
interface PagedCustomerResponse {
  content: CustomerListItemDTO[];
  totalElements: number;
  totalPages: number;
  size: number;
  number: number;
  numberOfElements: number;
  first: boolean;
  last: boolean;
}
```

### API Specifications

**Customer API Endpoints** [Source: architecture.md#REST API Specification]:

```yaml
GET /api/customers
  Summary: List customers with pagination, filtering, sorting (Query)
  Security: bearerAuth (JWT token required)
  Query Parameters:
    - page (optional, default=0): Page number (0-indexed)
    - size (optional, default=20): Page size
    - sort (optional, default=name): Sort field (name, email, createdAt)
    - direction (optional, default=asc): Sort direction (asc, desc)
    - search (optional): Search term for name or email (case-insensitive contains)
  Response 200:
    PagedCustomerResponse with content array and pagination metadata
  Response 401: Unauthorized (missing or invalid JWT)

GET /api/customers/{id}
  Summary: Get customer by ID (Query)
  Security: bearerAuth (JWT token required)
  Path Parameters:
    - id (required): UUID of customer
  Response 200: CustomerResponseDTO
  Response 404: Customer not found
  Response 401: Unauthorized

POST /api/customers
  Summary: Create customer (Command)
  Security: bearerAuth (JWT token required)
  Request Body: CreateCustomerDTO
  Response 201: CustomerResponseDTO
  Response 400: Validation errors
  Response 401: Unauthorized

PUT /api/customers/{id}
  Summary: Update customer (Command)
  Security: bearerAuth (JWT token required)
  Path Parameters:
    - id (required): UUID of customer
  Request Body: UpdateCustomerDTO
  Response 200: CustomerResponseDTO
  Response 400: Validation errors
  Response 404: Customer not found
  Response 401: Unauthorized

DELETE /api/customers/{id}
  Summary: Delete customer (Command - soft delete)
  Security: bearerAuth (JWT token required)
  Path Parameters:
    - id (required): UUID of customer
  Response 204: No content (success)
  Response 404: Customer not found
  Response 401: Unauthorized
```

### Component Specifications

**Frontend Customer Module** [Source: architecture.md#Frontend Components - Customer Management Module]:

**Component Hierarchy:**
```
app/customers/
  ├── page.tsx (Customer list page)
  ├── new/
  │   └── page.tsx (Create customer page)
  └── [id]/
      └── page.tsx (Edit customer page)

components/customers/
  ├── customer-list.tsx (Data table with search/filter/sort)
  ├── customer-form.tsx (Create/edit form with validation)
  └── delete-customer-dialog.tsx (Confirmation dialog)

lib/api/
  └── customers.ts (API client for customer operations)

lib/stores/
  └── customer-store.ts (Zustand store for customer state)
```

**CustomerList Component Specification:**
- Props: None (uses Zustand store)
- Features:
  - Data table with columns: name, email, phone, createdAt, actions
  - Search input (debounced, min 2 characters)
  - Sortable columns (click header to toggle asc/desc)
  - Pagination controls (previous, next, page numbers)
  - Loading skeleton during fetch
  - Empty state when no results
  - Error message on API failure
  - Action buttons: Edit (navigate to /customers/[id]), Delete (open dialog)
  - Create button (navigate to /customers/new)
- Dependencies: Shadcn/ui Table, Input, Button, Skeleton

**CustomerForm Component Specification:**
- Props: `{ mode: 'create' | 'edit', customerId?: string, onSuccess?: () => void }`
- Features:
  - Form fields with labels and validation
  - Required indicators on required fields
  - Inline validation errors
  - API error display
  - Submit button with loading state
  - Cancel button (navigate back)
- Validation rules:
  - name: required, max 255 characters
  - email: required, valid email format, max 255 characters
  - phone: optional, valid phone format
  - address fields: optional
- Dependencies: React Hook Form, Shadcn/ui Form components, Zod for schema validation

**DeleteCustomerDialog Component Specification:**
- Props: `{ customer: Customer | null, open: boolean, onOpenChange: (open: boolean) => void, onSuccess: () => void }`
- Features:
  - Display customer name in confirmation message
  - Cancel button (closes dialog)
  - Delete button (calls API, shows loading state)
  - Toast notification on success
  - Toast notification on error
- Dependencies: Shadcn/ui AlertDialog, Toast

**Customer Store Interface:**
```typescript
interface CustomerStore {
  // State
  customers: CustomerListItemDTO[];
  selectedCustomer: CustomerResponseDTO | null;
  loading: boolean;
  error: string | null;

  // Pagination state
  page: number;
  size: number;
  totalPages: number;
  totalElements: number;

  // Filter/sort state
  searchTerm: string;
  sortBy: string;
  sortDirection: 'asc' | 'desc';

  // Actions
  fetchCustomers: () => Promise<void>;
  fetchCustomerById: (id: string) => Promise<void>;
  createCustomer: (data: CreateCustomerDTO) => Promise<CustomerResponseDTO>;
  updateCustomer: (id: string, data: UpdateCustomerDTO) => Promise<CustomerResponseDTO>;
  deleteCustomer: (id: string) => Promise<void>;
  setPage: (page: number) => void;
  setSearchTerm: (term: string) => void;
  setSortBy: (field: string, direction: 'asc' | 'desc') => void;
  clearError: () => void;
}
```

### File Locations

**Frontend** [Source: architecture.md#Unified Project Structure]:
```
invoice-me/
  ├── app/
  │   └── customers/
  │       ├── page.tsx (list page)
  │       ├── new/
  │       │   └── page.tsx (create page)
  │       └── [id]/
  │           └── page.tsx (edit page)
  ├── components/
  │   └── customers/
  │       ├── customer-list.tsx
  │       ├── customer-form.tsx
  │       └── delete-customer-dialog.tsx
  ├── lib/
  │   ├── api/
  │   │   ├── types.ts (update with Customer types)
  │   │   └── customers.ts (new API client)
  │   └── stores/
  │       └── customer-store.ts (new Zustand store)
  └── __tests__/
      ├── components/
      │   └── customers/
      │       ├── customer-list.test.tsx
      │       ├── customer-form.test.tsx
      │       └── delete-customer-dialog.test.tsx
      └── lib/
          ├── api/
          │   └── customers.test.ts
          └── stores/
              └── customer-store.test.ts
```

### Testing Requirements

**Testing Strategy** [Source: architecture.md#Tech Stack]:
- Frontend: Jest 29.x + React Testing Library 14.x
- Component tests with @testing-library/react
- Mock API calls using MSW (Mock Service Worker) or jest.mock
- E2E tests with Playwright 1.40.x (optional for this story)

**Test Scenarios:**

1. Customer API Client:
   - getCustomers() calls correct endpoint with query params
   - getCustomerById() returns customer data
   - createCustomer() posts data and returns created customer
   - updateCustomer() puts data and returns updated customer
   - deleteCustomer() deletes and returns 204
   - All methods include JWT auth header

2. Customer Store:
   - fetchCustomers() updates customers state
   - fetchCustomers() handles loading and error states
   - fetchCustomerById() updates selectedCustomer
   - createCustomer() adds customer optimistically
   - updateCustomer() updates customer in list
   - deleteCustomer() removes customer from list
   - Pagination actions update state correctly
   - Search and sort actions trigger refetch

3. CustomerList Component:
   - Renders table with customer data
   - Shows loading skeleton when loading
   - Shows empty state when no customers
   - Shows error message on error
   - Search input triggers debounced search
   - Column headers toggle sort direction
   - Pagination buttons navigate pages
   - Edit button navigates to edit page
   - Delete button opens confirmation dialog
   - Create button navigates to new page

4. CustomerForm Component:
   - Renders all form fields
   - Shows validation errors for invalid input
   - Submits valid data to API
   - Shows loading state during submission
   - Calls onSuccess after successful submission
   - Displays API errors
   - Pre-populates fields in edit mode
   - Cancel button navigates back

5. DeleteCustomerDialog Component:
   - Renders with customer name
   - Cancel button closes dialog
   - Delete button calls deleteCustomer
   - Shows loading state during deletion
   - Shows success toast on success
   - Shows error toast on failure
   - Calls onSuccess after successful deletion

**Test Coverage Goals:**
- API client: 100% coverage
- Store: 90%+ coverage
- Components: 80%+ coverage
- Overall: 80%+ minimum

### Technical Constraints

**Dependencies** [Source: architecture.md#Tech Stack]:
- Next.js 14.x with App Router
- React 18.x
- TypeScript 5.x
- Zustand 4.x for state management
- React Hook Form for form state
- Zod for schema validation
- Shadcn/ui components (Table, Form, Button, Input, AlertDialog, Toast)
- Tailwind CSS 3.x for styling
- date-fns for date formatting (if needed)

**Performance Requirements** [Source: prd.md#Non Functional Requirements]:
- NFR2: The UI must provide smooth, responsive interactions without noticeable lag
- Debounce search input (300ms delay)
- Optimistic updates for create/update/delete
- Loading skeletons for better perceived performance
- Pagination to avoid loading too many customers at once

**Accessibility Requirements** [Source: prd.md#User Interface Design Goals]:
- WCAG AA compliance
- Proper ARIA labels on interactive elements
- Keyboard navigation support (tab, enter, escape)
- Focus management (form fields, dialogs)
- Screen reader friendly (semantic HTML, alt text)
- Sufficient color contrast ratios

**Responsive Design** [Source: prd.md#User Interface Design Goals]:
- Desktop: Full table view with all columns (1024px+)
- Tablet: Responsive table or card layout (768px-1023px)
- Mobile: Card layout or horizontal scroll table (< 768px)
- Touch-friendly buttons and inputs (44px min touch target)

**UI/UX Guidelines** [Source: prd.md#User Interface Design Goals]:
- Clean, professional aesthetic for B2B financial software
- Neutral color palette with accent colors
- Clear visual hierarchy and typography
- Inline validation with real-time feedback
- Contextual actions (row-level edit/delete)
- Empty states with helpful messages
- Loading states and error handling
- Success/error toast notifications

**API Client Integration:**
```typescript
// Reuse existing API client setup from lib/api/client.ts
// JWT token automatically injected via interceptor
// Error handling standardized across all API calls
import { apiClient } from './client';

export const customerApi = {
  getCustomers: async (params: {
    page?: number;
    size?: number;
    sort?: string;
    direction?: 'asc' | 'desc';
    search?: string;
  }): Promise<PagedCustomerResponse> => {
    const response = await apiClient.get('/customers', { params });
    return response.data;
  },

  // ... other methods
};
```

**Zustand Store Pattern:**
```typescript
// Follow established pattern from auth-store.ts
import { create } from 'zustand';
import { customerApi } from '../api/customers';

export const useCustomerStore = create<CustomerStore>((set, get) => ({
  // Initial state
  customers: [],
  selectedCustomer: null,
  loading: false,
  error: null,
  page: 0,
  size: 20,
  totalPages: 0,
  totalElements: 0,
  searchTerm: '',
  sortBy: 'name',
  sortDirection: 'asc',

  // Actions
  fetchCustomers: async () => {
    set({ loading: true, error: null });
    try {
      const { page, size, sortBy, sortDirection, searchTerm } = get();
      const response = await customerApi.getCustomers({
        page,
        size,
        sort: sortBy,
        direction: sortDirection,
        search: searchTerm || undefined,
      });
      set({
        customers: response.content,
        totalPages: response.totalPages,
        totalElements: response.totalElements,
        loading: false,
      });
    } catch (error) {
      set({ error: 'Failed to fetch customers', loading: false });
    }
  },

  // ... other actions
}));
```

## Testing
- Unit tests required for API client and Zustand store
- Component tests for all customer components using React Testing Library
- Test form validation (required fields, email format, phone format)
- Test loading states, error states, and empty states
- Test pagination, search, and sort functionality
- Test CRUD operations flow (create, read, update, delete)
- Test responsive behavior at different breakpoints
- Test accessibility (keyboard navigation, ARIA labels)
- Minimum 80% code coverage for new code
- Tests should follow AAA pattern (Arrange, Act, Assert)
- Mock API calls using MSW or jest.mock
- Use @testing-library/user-event for user interactions

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-08 | v1.0 | Initial story creation from PRD Epic 1 Story 1.5 | Claude (Dev Agent) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
None yet - will be populated during implementation

### Completion Notes List
None yet - will be populated during implementation

### File List
None yet - will be populated during implementation

## QA Results
Not yet reviewed
