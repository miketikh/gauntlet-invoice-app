# Story 3.5: Payment History & Reconciliation UI

## Status
Draft

## Story
**As a** user,
**I want** to view payment history and reconciliation details,
**so that** I can track all payments and verify account balances.

## Acceptance Criteria
1. Payment history tab on invoice detail showing all payments
2. Global payments page with searchable payment list
3. Payment details modal showing full payment information
4. Balance reconciliation view per customer showing all invoices/payments
5. Payment method filter and summary statistics
6. Date range picker for payment history filtering
7. Export button for payment data (CSV format placeholder)
8. Visual indicators for partial vs full payments

## Tasks / Subtasks
- [ ] Create PaymentHistory component for invoice detail (AC: 1, 8)
  - [ ] Create PaymentHistory.tsx in components/payments/
  - [ ] Define component props interface:
    - invoiceId: string (invoice to show payments for)
    - invoice?: InvoiceResponseDTO (optional, for context)
  - [ ] Fetch payments using API: GET /api/invoices/{invoiceId}/payments
  - [ ] Use React Query or useEffect for data fetching
  - [ ] Display payments in a table or list:
    - Columns: Date, Amount, Method, Reference, Balance, Status
    - Show running balance for each payment (from API)
    - Sort chronologically (oldest to newest)
  - [ ] Show empty state if no payments:
    - "No payments recorded yet"
    - Icon and message
  - [ ] Add visual indicators for payment types:
    - Partial payment: blue badge "Partial"
    - Full payment: green badge "Full Payment"
    - Determine by: if remainingBalance > 0 after payment, it's partial
  - [ ] Display total paid at bottom:
    - "Total Paid: ${sum of all payments}"
    - "Remaining Balance: ${invoice.balance}"
  - [ ] Style with Shadcn/ui Table component
  - [ ] Responsive: stack on mobile, table on desktop
  - [ ] Add loading state while fetching
  - [ ] Handle errors gracefully

- [ ] Integrate payment history into InvoiceDetail page (AC: 1)
  - [ ] Modify InvoiceDetail.tsx in app/(dashboard)/invoices/[id]/page.tsx
  - [ ] Add tabs or sections to invoice detail:
    - "Details" tab: Invoice details and line items
    - "Payments" tab: Payment history
  - [ ] Use Shadcn/ui Tabs component
  - [ ] Render PaymentHistory component in Payments tab
  - [ ] Pass invoiceId and invoice props
  - [ ] Default to Details tab
  - [ ] Show payment count badge on Payments tab: "Payments (3)"
  - [ ] Ensure tab navigation works with keyboard (arrows, tab)
  - [ ] Maintain tab state in URL if possible

- [ ] Create global Payments page (AC: 2, 5, 6)
  - [ ] Create page: app/(dashboard)/payments/page.tsx
  - [ ] Set up page layout with header:
    - Page title: "Payment History"
    - Breadcrumb navigation
  - [ ] Create filters section:
    - Date range picker (start date, end date)
    - Customer filter (dropdown or autocomplete)
    - Payment method filter (checkboxes or multi-select)
    - Search by reference number
  - [ ] Create PaymentList component:
    - Fetch payments using API: GET /api/payments with filters
    - Display in data table (Shadcn/ui Table)
    - Columns: Date, Invoice #, Customer, Amount, Method, Reference, Balance
    - Pagination support (page, size controls)
    - Sorting support (click column headers)
  - [ ] Apply filters to API query:
    - Build query params from filter state
    - Refetch data when filters change
    - Show loading state during fetch
  - [ ] Show total count: "Showing 20 of 145 payments"
  - [ ] Add export button (placeholder): "Export CSV" (AC: 7)
  - [ ] Responsive design: filters collapse on mobile

- [ ] Create PaymentFilters component (AC: 5, 6)
  - [ ] Create PaymentFilters.tsx in components/payments/
  - [ ] Define props:
    - filters: PaymentHistoryFilters (current filter state)
    - onFiltersChange: (filters: PaymentHistoryFilters) => void
  - [ ] Create date range picker:
    - Use Shadcn/ui Calendar component
    - Two date inputs: Start Date, End Date
    - Validation: end date >= start date
    - Clear button to reset dates
  - [ ] Create customer filter:
    - Dropdown or autocomplete of all customers
    - Fetch customer list from API: GET /api/customers
    - Allow "All Customers" option
  - [ ] Create payment method filter:
    - Multi-select or checkbox group
    - Options: Credit Card, Bank Transfer, Check, Cash
    - Allow multiple selections
    - "All Methods" to clear filter
  - [ ] Create reference search:
    - Text input for reference number
    - Debounce input (500ms) before applying filter
  - [ ] Add "Apply Filters" button (or apply on change)
  - [ ] Add "Clear Filters" button to reset all
  - [ ] Show active filter count: "3 filters active"
  - [ ] Style with Shadcn/ui components
  - [ ] Responsive: stack filters vertically on mobile

- [ ] Create PaymentStatistics component (AC: 5)
  - [ ] Create PaymentStatistics.tsx in components/payments/
  - [ ] Fetch payment statistics from API: GET /api/payments/statistics
  - [ ] Display summary cards:
    - Total Collected (all time)
    - Collected Today
    - Collected This Month
    - Collected This Year
  - [ ] Display payment breakdown by method:
    - Credit Card: $X (Y%)
    - Bank Transfer: $X (Y%)
    - Check: $X (Y%)
    - Cash: $X (Y%)
  - [ ] Use Shadcn/ui Card components for each metric
  - [ ] Add icons for each payment method
  - [ ] Format currency values consistently
  - [ ] Responsive grid layout (1 column mobile, 4 columns desktop)
  - [ ] Show loading skeleton while fetching
  - [ ] Refresh statistics when filters applied (optional)

- [ ] Create PaymentDetails modal (AC: 3)
  - [ ] Create PaymentDetailsModal.tsx in components/payments/
  - [ ] Define props:
    - paymentId: string (payment to display)
    - open: boolean
    - onOpenChange: (open: boolean) => void
  - [ ] Fetch payment details: GET /api/payments/{paymentId}
  - [ ] Use Shadcn/ui Dialog component
  - [ ] Display all payment information:
    - Payment ID
    - Invoice Number (link to invoice)
    - Customer Name (link to customer)
    - Payment Date
    - Amount (large, emphasized)
    - Payment Method (with icon)
    - Reference Number
    - Notes (if any)
    - Created At, Created By
  - [ ] Display invoice context:
    - Invoice Total
    - Remaining Balance (after this payment)
    - Invoice Status
  - [ ] Add "View Invoice" button linking to invoice detail
  - [ ] Add "View Customer" button linking to customer detail
  - [ ] Style with clear sections and visual hierarchy
  - [ ] Responsive layout
  - [ ] Loading state while fetching payment details

- [ ] Add payment details trigger to PaymentList (AC: 3)
  - [ ] Make payment rows clickable in PaymentList
  - [ ] On click, open PaymentDetailsModal with selected payment ID
  - [ ] Alternative: Add "View Details" icon button in each row
  - [ ] Ensure keyboard accessible (Enter key to open modal)
  - [ ] Highlight row on hover to indicate clickability
  - [ ] Show cursor pointer on hover

- [ ] Create CustomerReconciliation view (AC: 4)
  - [ ] Create CustomerReconciliation.tsx in components/payments/
  - [ ] Define props:
    - customerId: string
  - [ ] Fetch customer invoices: GET /api/invoices?customerId={id}
  - [ ] Fetch customer payments: GET /api/payments?customerId={id}
  - [ ] Display reconciliation summary:
    - Total Invoiced: sum of all invoice totals
    - Total Paid: sum of all payments
    - Outstanding Balance: total invoiced - total paid
  - [ ] Display invoices table:
    - Columns: Invoice #, Date, Total, Paid, Balance, Status
    - Show each invoice with payment status
    - Expand row to show payments for that invoice
  - [ ] Display payments table:
    - All payments for this customer
    - Link to associated invoice
  - [ ] Add visual reconciliation indicator:
    - Green checkmark if all invoices paid
    - Yellow warning if partial payments pending
    - Red alert if overdue invoices
  - [ ] Style with Shadcn/ui components
  - [ ] Add print/export option for reconciliation report

- [ ] Add reconciliation to Customer detail page (AC: 4)
  - [ ] Modify CustomerDetail.tsx or create new tab
  - [ ] Add "Reconciliation" tab to customer detail page
  - [ ] Render CustomerReconciliation component in tab
  - [ ] Pass customerId prop
  - [ ] Show summary at top of tab
  - [ ] Provide navigation to invoices and payments

- [ ] Implement CSV export placeholder (AC: 7)
  - [ ] Add "Export CSV" button to Payments page
  - [ ] Add icon (download icon)
  - [ ] On click, show toast: "Export functionality coming soon!"
  - [ ] Or implement basic CSV export:
    - Convert payment data to CSV format
    - Include columns: Date, Invoice, Customer, Amount, Method, Reference, Balance
    - Use csv library or manual CSV string building
    - Trigger browser download: `window.open('data:text/csv;charset=utf-8,' + csvContent)`
  - [ ] If implementing CSV:
    - Respect current filters (export filtered data)
    - Include all pages, not just current page
    - Show loading state during export
    - Limit to reasonable row count (e.g., 10,000 rows)
  - [ ] Add tooltip explaining export format
  - [ ] Ensure accessibility (keyboard accessible)

- [ ] Add visual indicators for payment types (AC: 8)
  - [ ] Create helper function: getPaymentType(payment: PaymentResponseDTO)
    - If payment.remainingBalance === 0, return 'full'
    - If payment.remainingBalance > 0, return 'partial'
    - Return type affects badge color and text
  - [ ] Create PaymentTypeBadge component:
    - Props: type: 'full' | 'partial'
    - Full payment: green badge, "Full Payment"
    - Partial payment: blue badge, "Partial"
  - [ ] Use PaymentTypeBadge in payment tables:
    - PaymentHistory component
    - Global PaymentList component
    - PaymentDetailsModal
  - [ ] Add icon to badge (checkmark for full, clock for partial)
  - [ ] Ensure color contrast for accessibility
  - [ ] Add tooltip explaining payment type

- [ ] Create payment API service methods (AC: 2, 3, 5)
  - [ ] Update lib/api/payments.ts
  - [ ] Create getPayments function:
    - Type: getPayments(filters: PaymentHistoryFilters): Promise<Page<PaymentResponseDTO>>
    - API call: GET /api/payments with query params
    - Build query string from filters
    - Include pagination params (page, size, sort)
    - Return paginated response
  - [ ] Create getPaymentById function:
    - Type: getPaymentById(id: string): Promise<PaymentResponseDTO>
    - API call: GET /api/payments/{id}
    - Return single payment with details
  - [ ] Create getInvoicePayments function:
    - Type: getInvoicePayments(invoiceId: string): Promise<PaymentResponseDTO[]>
    - API call: GET /api/invoices/{invoiceId}/payments
    - Return list of payments for invoice
  - [ ] Create getPaymentStatistics function:
    - Type: getPaymentStatistics(filters?: DateRangeFilter): Promise<PaymentStatistics>
    - API call: GET /api/payments/statistics
    - Optional date range filters
    - Return aggregated statistics
  - [ ] Add error handling for all functions
  - [ ] Include JWT token in all requests

- [ ] Create TypeScript types for filters and pagination (AC: 2, 5, 6)
  - [ ] Update types/payment.ts
  - [ ] Define PaymentHistoryFilters:
    ```typescript
    interface PaymentHistoryFilters {
      customerId?: string;
      startDate?: Date;
      endDate?: Date;
      paymentMethod?: PaymentMethod[];
      reference?: string;
      page?: number;
      size?: number;
      sort?: string;
    }
    ```
  - [ ] Define Page<T> generic type:
    ```typescript
    interface Page<T> {
      content: T[];
      page: number;
      size: number;
      totalElements: number;
      totalPages: number;
    }
    ```
  - [ ] Define PaymentStatistics:
    ```typescript
    interface PaymentStatistics {
      totalCollected: number;
      collectedToday: number;
      collectedThisMonth: number;
      collectedThisYear: number;
      totalPaymentCount: number;
      byMethod: Record<PaymentMethod, number>;
      byMonth: Record<string, number>;
    }
    ```
  - [ ] Ensure alignment with backend types

- [ ] Implement date range picker (AC: 6)
  - [ ] Use Shadcn/ui Calendar component
  - [ ] Create DateRangePicker component (or use existing)
  - [ ] Two date inputs: Start Date, End Date
  - [ ] Calendar popover for date selection
  - [ ] Validation: end date must be >= start date
  - [ ] Clear button to reset both dates
  - [ ] Format dates consistently (e.g., MM/DD/YYYY)
  - [ ] Bind to PaymentFilters state
  - [ ] Accessible keyboard navigation
  - [ ] Mobile-friendly date picker

- [ ] Add payment method filter (AC: 5)
  - [ ] Create PaymentMethodFilter component
  - [ ] Multi-select checkboxes for payment methods:
    - Credit Card
    - Bank Transfer
    - Check
    - Cash
  - [ ] "All Methods" checkbox to select/deselect all
  - [ ] Show count of selected methods
  - [ ] Apply filter to API query
  - [ ] Style with Shadcn/ui Checkbox components
  - [ ] Accessible labels and keyboard navigation

- [ ] Implement pagination for payment list (AC: 2)
  - [ ] Use Shadcn/ui Pagination component
  - [ ] Show page controls: Previous, 1, 2, 3, Next
  - [ ] Display current page and total pages
  - [ ] Show total record count: "Showing 1-20 of 145"
  - [ ] Handle page change: update filters and refetch data
  - [ ] Page size selector: 10, 20, 50, 100
  - [ ] Persist page state in URL query params
  - [ ] Keyboard accessible (arrows, Enter)
  - [ ] Disable Previous on first page, Next on last page

- [ ] Implement sorting for payment list (AC: 2)
  - [ ] Add sort indicators to table column headers
  - [ ] Sortable columns: Date, Amount, Invoice Number
  - [ ] Click header to toggle sort direction:
    - First click: ascending
    - Second click: descending
    - Third click: remove sort (default)
  - [ ] Show sort indicator (up/down arrow) on active column
  - [ ] Update API query with sort parameter
  - [ ] Default sort: paymentDate descending (newest first)
  - [ ] Ensure keyboard accessible (Enter to toggle sort)

- [ ] Add loading states and skeletons (AC: 1, 2, 3, 5)
  - [ ] Create loading skeleton for PaymentHistory table
  - [ ] Create loading skeleton for PaymentList table
  - [ ] Create loading skeleton for PaymentStatistics cards
  - [ ] Use Shadcn/ui Skeleton component
  - [ ] Show skeleton while data is loading
  - [ ] Match skeleton layout to actual content
  - [ ] Smooth transition from skeleton to data
  - [ ] Show loading spinner on filter apply
  - [ ] Show loading state in PaymentDetailsModal

- [ ] Implement error handling (AC: 1, 2, 3)
  - [ ] Show error state if payment fetch fails
  - [ ] Display user-friendly error message
  - [ ] Add retry button for failed requests
  - [ ] Handle 404 errors (invoice not found, payment not found)
  - [ ] Handle network errors gracefully
  - [ ] Log errors to console in development
  - [ ] Show toast notification for errors
  - [ ] Don't expose technical details to users

- [ ] Add navigation menu item for Payments (AC: 2)
  - [ ] Update main navigation menu
  - [ ] Add "Payments" menu item
  - [ ] Link to /payments page
  - [ ] Add icon (dollar sign or payment icon)
  - [ ] Highlight active state when on Payments page
  - [ ] Ensure keyboard navigation works
  - [ ] Position appropriately in menu hierarchy

- [ ] Style payment components with Shadcn/ui (AC: 1-8)
  - [ ] Use consistent Shadcn/ui components throughout:
    - Table for payment lists
    - Card for statistics
    - Dialog for payment details
    - Tabs for invoice detail sections
    - Badge for payment type indicators
    - Calendar for date pickers
    - Checkbox for payment method filter
  - [ ] Apply Tailwind CSS classes for spacing, colors, typography
  - [ ] Ensure responsive design (mobile, tablet, desktop)
  - [ ] Use consistent color scheme:
    - Green for full payments, success states
    - Blue for partial payments, info states
    - Red for errors, overdue indicators
  - [ ] Maintain visual hierarchy with font sizes and weights
  - [ ] Follow Shadcn/ui design patterns

- [ ] Implement accessibility for payment views (AC: 1-8)
  - [ ] All tables have proper headers (<th> elements)
  - [ ] Use semantic HTML (table, thead, tbody)
  - [ ] Add ARIA labels for icons and buttons
  - [ ] Ensure keyboard navigation works:
    - Tab through filters and controls
    - Enter to open payment details
    - Arrow keys for date picker
  - [ ] Support screen readers:
    - Announce table data correctly
    - Announce filter changes
    - Announce loading states
  - [ ] Ensure color contrast meets WCAG AA
  - [ ] Add focus indicators for keyboard navigation
  - [ ] Test with keyboard-only navigation
  - [ ] Test with screen reader (VoiceOver, NVDA)

- [ ] Create comprehensive UI tests (AC: 1-8)
  - [ ] Create PaymentHistory.test.tsx
  - [ ] Test component renders with payments
  - [ ] Test empty state when no payments
  - [ ] Test running balance display
  - [ ] Test partial vs full payment indicators
  - [ ] Create PaymentList.test.tsx
  - [ ] Test payment list renders with data
  - [ ] Test filters apply correctly
  - [ ] Test pagination works
  - [ ] Test sorting works
  - [ ] Test payment details modal opens
  - [ ] Create PaymentFilters.test.tsx
  - [ ] Test date range picker
  - [ ] Test customer filter
  - [ ] Test payment method filter
  - [ ] Test clear filters
  - [ ] Create PaymentStatistics.test.tsx
  - [ ] Test statistics display correctly
  - [ ] Test loading state
  - [ ] Create CustomerReconciliation.test.tsx
  - [ ] Test reconciliation summary
  - [ ] Test invoice and payment tables
  - [ ] Use React Testing Library
  - [ ] Mock API responses
  - [ ] Test accessibility with axe-core

- [ ] Add E2E tests for payment history (AC: 1-8)
  - [ ] Create payment-history.spec.ts (Playwright)
  - [ ] Test viewing payment history on invoice detail:
    - Navigate to invoice with payments
    - Click "Payments" tab
    - Verify payments displayed
    - Verify running balance shown
  - [ ] Test global payments page:
    - Navigate to Payments page
    - Verify payment list displays
    - Apply date range filter
    - Verify filtered results
    - Apply payment method filter
    - Verify filtered results
    - Click payment row to view details
    - Verify payment details modal opens
  - [ ] Test customer reconciliation:
    - Navigate to customer detail
    - Click "Reconciliation" tab
    - Verify reconciliation summary
    - Verify invoices and payments listed
  - [ ] Test export button:
    - Click "Export CSV"
    - Verify toast or download initiated
  - [ ] Test pagination and sorting
  - [ ] Test keyboard navigation
  - [ ] Run E2E tests in CI pipeline

- [ ] Update payment store with query functions (AC: 2, 3, 5)
  - [ ] Update lib/stores/payment-store.ts (if using Zustand)
  - [ ] Add state for payment list:
    - payments: Page<PaymentResponseDTO>
    - filters: PaymentHistoryFilters
    - loading: boolean
    - error: string | null
  - [ ] Add actions:
    - fetchPayments(filters: PaymentHistoryFilters)
    - setFilters(filters: PaymentHistoryFilters)
    - fetchPaymentById(id: string)
    - fetchPaymentStatistics()
  - [ ] Call API service methods from actions
  - [ ] Update store state on success/error
  - [ ] Provide selectors for components to access state
  - [ ] Alternatively, use React Query instead of Zustand for server state

- [ ] Add currency and date formatting utilities (AC: 1, 2, 4)
  - [ ] Ensure formatCurrency utility exists in lib/utils.ts:
    ```typescript
    export function formatCurrency(amount: number): string {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
      }).format(amount);
    }
    ```
  - [ ] Add formatDate utility:
    ```typescript
    export function formatDate(date: Date | string): string {
      return new Intl.DateTimeFormat('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      }).format(new Date(date));
    }
    ```
  - [ ] Use utilities consistently across all payment components
  - [ ] Handle null/undefined dates gracefully

- [ ] Create payment icons and method indicators (AC: 5, 8)
  - [ ] Create PaymentMethodIcon component:
    - Props: method: PaymentMethod
    - Return icon based on method:
      - CreditCard: credit card icon
      - BankTransfer: bank building icon
      - Check: document icon
      - Cash: money/bill icon
  - [ ] Use icons from Lucide React or similar library
  - [ ] Add color coding to icons (optional)
  - [ ] Use icons in:
    - Payment method filter
    - Payment list table
    - Payment details modal
    - Payment statistics breakdown
  - [ ] Ensure icons are accessible (aria-label)

- [ ] Add responsive design for all payment views (AC: 1-8)
  - [ ] Payment history table:
    - Desktop: full table
    - Tablet: scrollable table
    - Mobile: stacked card view
  - [ ] Payment list:
    - Desktop: full table with all columns
    - Tablet: hide less important columns (reference, notes)
    - Mobile: card view with essential info
  - [ ] Payment filters:
    - Desktop: horizontal layout
    - Tablet: wrap filters to multiple rows
    - Mobile: vertical stack, collapsible
  - [ ] Payment statistics:
    - Desktop: 4-column grid
    - Tablet: 2-column grid
    - Mobile: single column
  - [ ] Payment details modal:
    - Desktop: wide dialog
    - Tablet: medium dialog
    - Mobile: full-screen dialog
  - [ ] Test on various screen sizes
  - [ ] Use Tailwind responsive classes (sm:, md:, lg:, xl:)

- [ ] Document payment history features (AC: 1-8)
  - [ ] Add JSDoc comments to all components
  - [ ] Document props and their purposes
  - [ ] Document API integration points
  - [ ] Add usage examples in component documentation
  - [ ] Update technical docs with payment history features
  - [ ] Document filter behavior and limitations
  - [ ] Document export functionality

## Dev Notes

### Previous Story Insights

**Story 3.4 Completion:**
Story 3.4 implemented payment recording UI:
- PaymentForm component with modal dialog
- Payment recording from invoice detail page
- Real-time balance calculation
- Client-side validation (amount, date, reference)
- Payment method dropdown
- Success notifications and invoice refresh
- Disabled states for Draft/Paid invoices
- Comprehensive component tests

**Story 3.3 Completion:**
Story 3.3 implemented payment queries and history:
- GetPaymentByIdQuery, ListPaymentsByInvoiceQuery, PaymentHistoryQuery
- GET /api/payments/{id}, GET /api/invoices/{id}/payments endpoints
- PaymentResponseDTO with invoice and customer context
- Running balance calculation for payment history
- Payment statistics for dashboard
- Comprehensive query tests

**Story 3.2 Completion:**
Story 3.2 implemented payment recording commands:
- RecordPaymentCommand and RecordPaymentCommandHandler
- POST /api/invoices/{id}/payments endpoint
- Transactional payment recording with invoice balance update
- Invoice status transition to Paid when balance reaches zero
- PaymentRecorded domain event
- Idempotency handling
- Integration and API tests

**Epic 2 UI Patterns:**
Stories 2.4 and 2.5 established UI patterns for invoice management:
- Tabbed interface for invoice detail (Details, Payments tabs)
- Data tables with sorting and filtering
- Modal dialogs for viewing details
- Status badges and visual indicators
- Responsive design patterns
- Loading states and error handling
- Export placeholders (CSV/PDF)

**Epic 1 UI Patterns:**
Story 1.5 implemented Customer UI:
- List view with searchable data table
- Pagination and sorting
- Filter UI components
- Detail views with tabs
- Responsive design
- Shadcn/ui component usage

### Data Models

**PaymentResponseDTO** [Source: Story 3.3]:
```typescript
interface PaymentResponseDTO {
  id: string;
  invoiceId: string;
  invoiceNumber: string;
  customerName: string;
  customerEmail: string;
  paymentDate: Date;
  amount: number;
  paymentMethod: PaymentMethod;
  reference: string;
  notes?: string;
  invoiceTotal: number;
  remainingBalance: number;    // Invoice balance after this payment
  runningBalance?: number;     // Only in payment history queries
  invoiceStatus: InvoiceStatus;
  createdAt: Date;
  createdBy: string;
}
```

**PaymentHistoryFilters** [Source: Story 3.3]:
```typescript
interface PaymentHistoryFilters {
  customerId?: string;
  startDate?: Date;
  endDate?: Date;
  paymentMethod?: PaymentMethod[];
  reference?: string;
  page?: number;
  size?: number;
  sort?: string;
}
```

**PaymentStatistics** [Source: Story 3.3]:
```typescript
interface PaymentStatistics {
  totalCollected: number;
  collectedToday: number;
  collectedThisMonth: number;
  collectedThisYear: number;
  totalPaymentCount: number;
  byMethod: Record<PaymentMethod, number>;
  byMonth: Record<string, number>;
}
```

**Page<T> Generic** [Common pagination pattern]:
```typescript
interface Page<T> {
  content: T[];
  page: number;
  size: number;
  totalElements: number;
  totalPages: number;
}
```

### API Specifications

**GET /api/invoices/{id}/payments** [Source: Story 3.3, architecture.md#API Specification]:

**Request:**
```
GET /api/invoices/660e8400-e29b-41d4-a716-446655440000/payments
Authorization: Bearer {jwt_token}
```

**Response (200 OK):**
```json
[
  {
    "id": "550e8400-1",
    "invoiceId": "660e8400",
    "invoiceNumber": "INV-2024-0123",
    "customerName": "Acme Corporation",
    "paymentDate": "2024-11-01",
    "amount": 200.00,
    "paymentMethod": "BankTransfer",
    "reference": "WIRE-001",
    "invoiceTotal": 500.00,
    "remainingBalance": 300.00,
    "runningBalance": 300.00,
    "invoiceStatus": "Sent"
  },
  {
    "id": "550e8400-2",
    "invoiceId": "660e8400",
    "invoiceNumber": "INV-2024-0123",
    "customerName": "Acme Corporation",
    "paymentDate": "2024-11-08",
    "amount": 100.00,
    "paymentMethod": "CreditCard",
    "reference": "VISA-1234",
    "invoiceTotal": 500.00,
    "remainingBalance": 200.00,
    "runningBalance": 200.00,
    "invoiceStatus": "Sent"
  }
]
```

**GET /api/payments** [Source: Story 3.3]:

**Request:**
```
GET /api/payments?customerId=770e8400&startDate=2024-01-01&endDate=2024-12-31&paymentMethod=CreditCard&page=0&size=20&sort=paymentDate,desc
Authorization: Bearer {jwt_token}
```

**Response (200 OK):**
```json
{
  "content": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "invoiceId": "660e8400-e29b-41d4-a716-446655440000",
      "invoiceNumber": "INV-2024-0123",
      "customerName": "Acme Corporation",
      "customerEmail": "billing@acme.com",
      "paymentDate": "2024-11-08",
      "amount": 250.00,
      "paymentMethod": "CreditCard",
      "reference": "VISA-****-1234",
      "invoiceTotal": 500.00,
      "remainingBalance": 250.00,
      "invoiceStatus": "Sent",
      "createdAt": "2024-11-08T14:30:00Z",
      "createdBy": "user@example.com"
    }
  ],
  "page": 0,
  "size": 20,
  "totalElements": 45,
  "totalPages": 3
}
```

**GET /api/payments/{id}** [Source: Story 3.3]:

**Request:**
```
GET /api/payments/{id}
Authorization: Bearer {jwt_token}
```

**Response (200 OK):**
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "invoiceId": "660e8400-e29b-41d4-a716-446655440000",
  "invoiceNumber": "INV-2024-0123",
  "customerName": "Acme Corporation",
  "customerEmail": "billing@acme.com",
  "paymentDate": "2024-11-08",
  "amount": 250.00,
  "paymentMethod": "CreditCard",
  "reference": "VISA-****-1234",
  "notes": "Partial payment received",
  "invoiceTotal": 500.00,
  "remainingBalance": 250.00,
  "invoiceStatus": "Sent",
  "createdAt": "2024-11-08T14:30:00Z",
  "createdBy": "user@example.com"
}
```

**GET /api/payments/statistics** [Source: Story 3.3]:

**Request:**
```
GET /api/payments/statistics?startDate=2024-01-01&endDate=2024-12-31
Authorization: Bearer {jwt_token}
```

**Response (200 OK):**
```json
{
  "totalCollected": 125000.00,
  "collectedToday": 1500.00,
  "collectedThisMonth": 15000.00,
  "collectedThisYear": 125000.00,
  "totalPaymentCount": 342,
  "byMethod": {
    "CreditCard": 50000.00,
    "BankTransfer": 60000.00,
    "Check": 10000.00,
    "Cash": 5000.00
  },
  "byMonth": {
    "2024-01": 10000.00,
    "2024-02": 12000.00,
    "2024-03": 11000.00,
    "2024-04": 13000.00,
    "2024-05": 10500.00,
    "2024-06": 9500.00,
    "2024-07": 11500.00,
    "2024-08": 12500.00,
    "2024-09": 10000.00,
    "2024-10": 11000.00,
    "2024-11": 9000.00,
    "2024-12": 5000.00
  }
}
```

### Component Specifications

**PaymentHistory Component** [Derived from PRD Epic 3 Story 3.5 AC 1, 8]:
- Location: components/payments/PaymentHistory.tsx
- Purpose: Display payment history for a specific invoice
- Props:
  - invoiceId: string (invoice to show payments for)
  - invoice?: InvoiceResponseDTO (optional, for context)
- Features:
  - Fetches payments from GET /api/invoices/{id}/payments
  - Displays payments in table format
  - Shows running balance for each payment
  - Visual indicators for partial vs full payments
  - Empty state when no payments
  - Total paid and remaining balance summary
- Dependencies: Shadcn/ui Table, API service, React Query or useEffect

**PaymentList Component** [Derived from PRD Epic 3 Story 3.5 AC 2]:
- Location: components/payments/PaymentList.tsx or app/(dashboard)/payments/page.tsx
- Purpose: Global payment list with filtering, sorting, pagination
- Features:
  - Fetches payments from GET /api/payments with filters
  - Data table with columns: Date, Invoice #, Customer, Amount, Method, Reference, Balance
  - Filtering: customer, date range, payment method, reference search
  - Sorting: by date, amount, invoice number
  - Pagination: page controls, page size selector
  - Click row to view payment details
  - Export CSV button
- Dependencies: Shadcn/ui Table, Pagination, PaymentFilters, API service

**PaymentFilters Component** [Derived from PRD Epic 3 Story 3.5 AC 5, 6]:
- Location: components/payments/PaymentFilters.tsx
- Purpose: Filter controls for payment list
- Props:
  - filters: PaymentHistoryFilters
  - onFiltersChange: (filters: PaymentHistoryFilters) => void
- Features:
  - Date range picker (start date, end date)
  - Customer dropdown/autocomplete
  - Payment method multi-select
  - Reference number search
  - Apply/Clear buttons
  - Active filter count indicator
- Dependencies: Shadcn/ui Calendar, Select, Checkbox, Input

**PaymentStatistics Component** [Derived from PRD Epic 3 Story 3.5 AC 5]:
- Location: components/payments/PaymentStatistics.tsx
- Purpose: Display payment statistics summary
- Features:
  - Fetches statistics from GET /api/payments/statistics
  - Summary cards: Total, Today, This Month, This Year
  - Breakdown by payment method with percentages
  - Responsive grid layout
  - Loading skeletons
- Dependencies: Shadcn/ui Card, API service

**PaymentDetailsModal Component** [Derived from PRD Epic 3 Story 3.5 AC 3]:
- Location: components/payments/PaymentDetailsModal.tsx
- Purpose: Show detailed information for a single payment
- Props:
  - paymentId: string
  - open: boolean
  - onOpenChange: (open: boolean) => void
- Features:
  - Fetches payment from GET /api/payments/{id}
  - Displays all payment fields
  - Shows invoice and customer context
  - Links to invoice and customer detail pages
  - Loading state
- Dependencies: Shadcn/ui Dialog, API service

**CustomerReconciliation Component** [Derived from PRD Epic 3 Story 3.5 AC 4]:
- Location: components/payments/CustomerReconciliation.tsx
- Purpose: Reconciliation view for a specific customer
- Props:
  - customerId: string
- Features:
  - Fetches customer invoices and payments
  - Reconciliation summary: total invoiced, total paid, outstanding
  - Invoices table with payment status
  - Payments table linked to invoices
  - Visual reconciliation indicators
  - Print/export option
- Dependencies: Shadcn/ui Table, API service

### File Locations

**Frontend Files** [Source: architecture.md#Unified Project Structure]:
```
app/(dashboard)/payments/
└── page.tsx                          # Global payments page (NEW)

app/(dashboard)/invoices/[id]/
└── page.tsx                          # Invoice detail page (MODIFY to add Payments tab)

app/(dashboard)/customers/[id]/
└── page.tsx                          # Customer detail page (MODIFY to add Reconciliation tab)

components/payments/
├── payment-history.tsx               # Payment history for invoice (NEW)
├── payment-list.tsx                  # Global payment list (NEW)
├── payment-filters.tsx               # Filter controls (NEW)
├── payment-statistics.tsx            # Statistics summary (NEW)
├── payment-details-modal.tsx         # Payment details dialog (NEW)
├── payment-type-badge.tsx            # Visual indicator for payment type (NEW)
├── payment-method-icon.tsx           # Icons for payment methods (NEW)
└── customer-reconciliation.tsx       # Customer reconciliation view (NEW)

lib/api/
└── payments.ts                       # Payment API service (ADD query methods)

types/
└── payment.ts                        # Payment TypeScript types (ADD filter and pagination types)

lib/stores/
└── payment-store.ts                  # Payment store (ADD query state if using Zustand)

lib/
└── utils.ts                          # Utilities (ADD formatDate helper)

__tests__/components/payments/
├── payment-history.test.tsx          # PaymentHistory tests (NEW)
├── payment-list.test.tsx             # PaymentList tests (NEW)
├── payment-filters.test.tsx          # PaymentFilters tests (NEW)
├── payment-statistics.test.tsx       # PaymentStatistics tests (NEW)
├── payment-details-modal.test.tsx    # PaymentDetailsModal tests (NEW)
└── customer-reconciliation.test.tsx  # CustomerReconciliation tests (NEW)

e2e/
└── payment-history.spec.ts           # E2E test for payment history (NEW)
```

### Testing Requirements

**Testing Strategy** [Source: architecture.md#Tech Stack, PRD Technical Assumptions]:
- Component tests with React Testing Library
- Test PaymentHistory renders with payments
- Test empty state when no payments
- Test running balance display
- Test payment type indicators (partial vs full)
- Test PaymentList with filters and pagination
- Test PaymentFilters controls
- Test PaymentStatistics displays correctly
- Test PaymentDetailsModal shows full details
- Test CustomerReconciliation summary
- E2E test for complete payment history flows
- Test keyboard navigation and accessibility
- Minimum 85% code coverage on UI components

**Component Test Examples**:
```typescript
describe('PaymentHistory', () => {
  const mockPayments: PaymentResponseDTO[] = [
    {
      id: '1',
      invoiceId: 'inv-123',
      invoiceNumber: 'INV-2024-0001',
      customerName: 'Acme Corp',
      paymentDate: new Date('2024-11-01'),
      amount: 200.00,
      paymentMethod: 'BankTransfer',
      reference: 'WIRE-001',
      invoiceTotal: 500.00,
      remainingBalance: 300.00,
      runningBalance: 300.00,
      invoiceStatus: 'Sent',
      // ... other fields
    },
    {
      id: '2',
      invoiceId: 'inv-123',
      invoiceNumber: 'INV-2024-0001',
      customerName: 'Acme Corp',
      paymentDate: new Date('2024-11-08'),
      amount: 300.00,
      paymentMethod: 'CreditCard',
      reference: 'VISA-1234',
      invoiceTotal: 500.00,
      remainingBalance: 0.00,
      runningBalance: 0.00,
      invoiceStatus: 'Paid',
      // ... other fields
    }
  ];

  it('should render payment history table', () => {
    render(<PaymentHistory invoiceId="inv-123" />);

    expect(screen.getByRole('table')).toBeInTheDocument();
    expect(screen.getByText('INV-2024-0001')).toBeInTheDocument();
  });

  it('should display running balance for each payment', () => {
    render(<PaymentHistory invoiceId="inv-123" />);

    expect(screen.getByText('$300.00')).toBeInTheDocument(); // First payment balance
    expect(screen.getByText('$0.00')).toBeInTheDocument();   // Second payment balance
  });

  it('should show partial payment badge', () => {
    render(<PaymentHistory invoiceId="inv-123" />);

    expect(screen.getByText('Partial')).toBeInTheDocument();
    expect(screen.getByText('Full Payment')).toBeInTheDocument();
  });

  it('should show empty state when no payments', () => {
    // Mock API to return empty array
    render(<PaymentHistory invoiceId="inv-456" />);

    expect(screen.getByText(/no payments recorded/i)).toBeInTheDocument();
  });
});

describe('PaymentList', () => {
  it('should filter payments by date range', async () => {
    render(<PaymentList />);

    const startDateInput = screen.getByLabelText(/start date/i);
    const endDateInput = screen.getByLabelText(/end date/i);

    await userEvent.type(startDateInput, '01/01/2024');
    await userEvent.type(endDateInput, '12/31/2024');

    // Verify API called with date range filters
    await waitFor(() => {
      expect(mockGetPayments).toHaveBeenCalledWith(
        expect.objectContaining({
          startDate: new Date('2024-01-01'),
          endDate: new Date('2024-12-31')
        })
      );
    });
  });

  it('should paginate results', async () => {
    render(<PaymentList />);

    const nextButton = screen.getByRole('button', { name: /next/i });
    await userEvent.click(nextButton);

    await waitFor(() => {
      expect(mockGetPayments).toHaveBeenCalledWith(
        expect.objectContaining({ page: 1 })
      );
    });
  });

  it('should open payment details on row click', async () => {
    render(<PaymentList />);

    const paymentRow = screen.getByText('INV-2024-0001');
    await userEvent.click(paymentRow);

    expect(screen.getByRole('dialog')).toBeInTheDocument();
    expect(screen.getByText('Payment Details')).toBeInTheDocument();
  });
});
```

### Technical Constraints

**Dependencies** [Source: architecture.md#Tech Stack]:
- Next.js 14.x
- TypeScript 5.x
- Shadcn/ui component library
- Tailwind CSS 3.x
- React Hook Form (for filters if needed)
- Zustand 4.x or React Query for state management
- Axios for API calls
- date-fns for date formatting and manipulation
- Lucide React for icons
- React Testing Library for component tests
- Playwright for E2E tests

**UI/UX Requirements** [Source: PRD User Interface Design Goals]:
- Master-Detail pattern for payment views
- Filterable data tables with pagination
- Responsive design (desktop, tablet, mobile)
- WCAG AA accessibility compliance
- Clear visual hierarchy with badges and indicators
- Loading states and error handling
- Consistent color scheme (green=success/full, blue=info/partial, red=error)
- Professional ERP aesthetic

**Performance Requirements** [Source: PRD NFR2]:
- Smooth, responsive interactions without lag
- Payment list should load within 200ms
- Filter application should be instant or near-instant
- Pagination should not cause noticeable delay
- Use React Query caching to minimize API calls
- Debounce search inputs (500ms)

**Data Requirements** [Source: Story 3.3]:
- Payment history includes running balance calculation
- Statistics aggregated by payment method and month
- Pagination support for large payment datasets
- Sorting by date, amount, invoice number
- Filtering by customer, date range, payment method, reference

### Coding Standards

**Critical Frontend Rules** [Source: architecture.md#Coding Standards]:
- Use TypeScript interfaces matching backend DTOs exactly
- Never mutate state directly
- Validate filters before sending to API
- Use Shadcn/ui components consistently
- Follow Next.js App Router patterns
- Handle errors gracefully with user-friendly messages
- Implement proper loading states
- Ensure accessibility (ARIA, keyboard navigation)
- Use React Query or similar for server state management
- Separate presentation components from data fetching

**Naming Conventions** [Source: architecture.md#Coding Standards]:
- Components: PascalCase (PaymentHistory.tsx)
- Hooks: camelCase with 'use' prefix (usePaymentFilters.ts)
- Types/Interfaces: PascalCase
- Functions: camelCase
- Constants: SCREAMING_SNAKE_CASE

**Table and List Patterns**:
- Use Shadcn/ui Table component for tabular data
- Support sorting on relevant columns
- Implement pagination for large datasets
- Show total record count
- Handle empty states gracefully
- Provide clear loading indicators
- Make rows clickable for details
- Ensure keyboard navigation works

**Filter Patterns**:
- Group related filters visually
- Apply filters on change or with explicit "Apply" button
- Debounce text search inputs
- Show active filter count
- Provide "Clear All" button
- Persist filter state in URL query params (optional)
- Show loading state while filtering

**Modal/Dialog Patterns**:
- Use Shadcn/ui Dialog component
- Ensure keyboard accessible (Escape to close)
- Focus management (focus first element on open)
- Return focus to trigger on close
- Loading state for async data
- Error handling within dialog
- Responsive sizing

**Accessibility Requirements**:
- All tables have proper structure (<table>, <thead>, <tbody>)
- Column headers use <th> elements
- Use ARIA labels for icons and controls
- Support keyboard navigation throughout
- Ensure color contrast meets WCAG AA
- Announce dynamic content changes to screen readers
- Focus indicators visible
- Test with keyboard-only navigation

## Testing
- Component tests for PaymentHistory with React Testing Library
- Test payment history table renders with data
- Test running balance calculation display
- Test payment type badges (partial vs full)
- Test empty state when no payments
- Component tests for PaymentList
- Test payment list table renders with data
- Test filters apply correctly (customer, date, method)
- Test pagination controls work
- Test sorting by column headers
- Test payment details modal opens on row click
- Component tests for PaymentFilters
- Test date range picker functionality
- Test customer filter dropdown
- Test payment method multi-select
- Test reference search input
- Test clear filters button
- Component tests for PaymentStatistics
- Test statistics cards display correctly
- Test payment method breakdown renders
- Test loading state shows skeletons
- Component tests for PaymentDetailsModal
- Test modal renders payment details
- Test links to invoice and customer
- Component tests for CustomerReconciliation
- Test reconciliation summary calculates correctly
- Test invoices and payments tables render
- E2E tests for payment history flows
- Test viewing payment history on invoice detail
- Test global payments page with filters
- Test pagination and sorting
- Test payment details modal
- Test customer reconciliation view
- Test export CSV button (placeholder or actual)
- Test keyboard navigation throughout
- Test accessibility with screen readers
- Minimum 85% code coverage on payment UI components

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-08 | v1.0 | Initial story creation from PRD Epic 3 Story 3.5 | Claude (Story Agent) |

## Dev Agent Record

### Agent Model Used
Not yet implemented

### Debug Log References
None yet - will be populated during implementation

### Completion Notes List
None yet - will be populated during implementation

### File List
None yet - will be populated during implementation

## QA Results
Not yet reviewed
